/**
Copyright (c) The New York Times, CMS Group, Matthew DeLambo

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License, version 2, as
published by the Free Software Foundation.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program as the file license.txt. If not, see
<http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt>

**/
window.rangy=function(){function d(a,b){var c=typeof a[b];return c==n||!!(c==k&&a[b])||c=="unknown"}function b(a,b){return!!(typeof a[b]==k&&a[b])}function a(a,b){return typeof a[b]!=m}function c(a){return function(b,c){for(var e=c.length;e--;)if(!a(b,c[e]))return!1;return!0}}function e(a){return a&&j(a,r)&&x(a,h)}function f(a){window.alert("Rangy not supported in your browser. Reason: "+a);q.initialized=!0;q.supported=!1}function g(){if(!q.initialized){var a,c=!1,p=!1;d(document,"createRange")&&
(a=document.createRange(),j(a,o)&&x(a,s)&&(c=!0),a.detach());if((a=b(document,"body")?document.body:document.getElementsByTagName("body")[0])&&d(a,"createTextRange"))a=a.createTextRange(),e(a)&&(p=!0);!c&&!p&&f("Neither Range nor TextRange are implemented");q.initialized=!0;q.features={implementsDomRange:c,implementsTextRange:p};c=E.concat(w);p=0;for(a=c.length;p<a;++p)try{c[p](q)}catch(h){b(window,"console")&&d(window.console,"log")&&window.console.log("Init listener threw an exception. Continuing.",
h)}}}function i(a){this.name=a;this.supported=this.initialized=!1}var k="object",n="function",m="undefined",s=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer","START_TO_START","START_TO_END","END_TO_START","END_TO_END"],o=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents",
"cloneRange","toString","detach"],h=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],r=["collapse","compareEndPoints","duplicate","getBookmark","moveToBookmark","moveToElementText","parentElement","pasteHTML","select","setEndPoint","getBoundingClientRect"],j=c(d),p=c(b),x=c(a),q={version:"1.2",initialized:!1,supported:!0,util:{isHostMethod:d,isHostObject:b,isHostProperty:a,areHostMethods:j,areHostObjects:p,areHostProperties:x,isTextRange:e},features:{},modules:{},
config:{alertOnWarn:!1,preferTextRange:!1}};q.fail=f;q.warn=function(a){a="Rangy warning: "+a;q.config.alertOnWarn?window.alert(a):typeof window.console!=m&&typeof window.console.log!=m&&window.console.log(a)};({}).hasOwnProperty?q.util.extend=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])}:f("hasOwnProperty not supported");var w=[],E=[];q.init=g;q.addInitListener=function(a){q.initialized?a(q):w.push(a)};var B=[];q.addCreateMissingNativeApiListener=function(a){B.push(a)};q.createMissingNativeApi=
function(a){a=a||window;g();for(var b=0,c=B.length;b<c;++b)B[b](a)};i.prototype.fail=function(a){this.initialized=!0;this.supported=!1;throw Error("Module '"+this.name+"' failed to load: "+a);};i.prototype.warn=function(a){q.warn("Module "+this.name+": "+a)};i.prototype.createError=function(a){return Error("Error in Rangy "+this.name+" module: "+a)};q.createModule=function(a,b){var c=new i(a);q.modules[a]=c;E.push(function(a){b(a,c);c.initialized=!0;c.supported=!0})};q.requireModules=function(a){for(var b=
0,c=a.length,e,d;b<c;++b){d=a[b];e=q.modules[d];if(!e||!(e instanceof i))throw Error("Module '"+d+"' not found");if(!e.supported)throw Error("Module '"+d+"' not supported");}};var z=!1,p=function(){z||(z=!0,q.initialized||g())};if(typeof window==m)f("No window found");else if(typeof document==m)f("No document found");else return d(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",p,!1),d(window,"addEventListener")?window.addEventListener("load",p,!1):d(window,"attachEvent")?
window.attachEvent("onload",p):f("Window does not have required addEventListener or attachEvent method"),q}();
rangy.createModule("DomUtil",function(d,b){function a(a){for(var b=0;a=a.previousSibling;)b++;return b}function c(a,b){var c=[],e;for(e=a;e;e=e.parentNode)c.push(e);for(e=b;e;e=e.parentNode)if(j(c,e))return e;return null}function e(a,b,c){for(c=c?a:a.parentNode;c;){a=c.parentNode;if(a===b)return c;c=a}return null}function f(a){a=a.nodeType;return a==3||a==4||a==8}function g(a,b){var c=b.nextSibling,e=b.parentNode;c?e.insertBefore(a,c):e.appendChild(a);return a}function i(a){if(a.nodeType==9)return a;
else if(typeof a.ownerDocument!=o)return a.ownerDocument;else if(typeof a.document!=o)return a.document;else if(a.parentNode)return i(a.parentNode);else throw Error("getDocument: no document found for node");}function k(a){return!a?"[No node]":f(a)?'"'+a.data+'"':a.nodeType==1?"<"+a.nodeName+(a.id?' id="'+a.id+'"':"")+">["+a.childNodes.length+"]":a.nodeName}function n(a){this._next=this.root=a}function m(a,b){this.node=a;this.offset=b}function s(a){this.code=this[a];this.codeName=a;this.message="DOMException: "+
this.codeName}var o="undefined",h=d.util;h.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||b.fail("document missing a Node creation method");h.isHostMethod(document,"getElementsByTagName")||b.fail("document missing getElementsByTagName method");var r=document.createElement("div");h.areHostMethods(r,["insertBefore","appendChild","cloneNode"])||b.fail("Incomplete Element implementation");r=document.createTextNode("test");h.areHostMethods(r,["splitText","deleteData",
"insertData","appendData","cloneNode"])||b.fail("Incomplete Text Node implementation");var j=function(a,b){for(var c=a.length;c--;)if(a[c]===b)return!0;return!1};n.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next,b;if(this._current){b=a.firstChild;if(!b)for(b=null;a!==this.root&&!(b=a.nextSibling);)a=a.parentNode;this._next=b}return this._current},detach:function(){this._current=this._next=this.root=null}};m.prototype={equals:function(a){return this.node===
a.node&this.offset==a.offset},inspect:function(){return"[DomPosition("+k(this.node)+":"+this.offset+")]"}};s.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11};s.prototype.toString=function(){return this.message};d.dom={arrayContains:j,getNodeIndex:a,getNodeLength:function(a){var b;return f(a)?a.length:(b=a.childNodes)?b.length:0},getCommonAncestor:c,isAncestorOf:function(a,b,c){for(b=c?b:
b.parentNode;b;)if(b===a)return!0;else b=b.parentNode;return!1},getClosestAncestorIn:e,isCharacterDataNode:f,insertAfter:g,splitDataNode:function(a,b){var c=a.cloneNode(!1);c.deleteData(0,b);a.deleteData(b,a.length-b);g(c,a);return c},getDocument:i,getWindow:function(a){a=i(a);if(typeof a.defaultView!=o)return a.defaultView;else if(typeof a.parentWindow!=o)return a.parentWindow;else throw Error("Cannot get a window object for node");},getIframeWindow:function(a){if(typeof a.contentWindow!=o)return a.contentWindow;
else if(typeof a.contentDocument!=o)return a.contentDocument.defaultView;else throw Error("getIframeWindow: No Window object found for iframe element");},getIframeDocument:function(a){if(typeof a.contentDocument!=o)return a.contentDocument;else if(typeof a.contentWindow!=o)return a.contentWindow.document;else throw Error("getIframeWindow: No Document object found for iframe element");},getBody:function(a){return h.isHostObject(a,"body")?a.body:a.getElementsByTagName("body")[0]},getRootContainer:function(a){for(var b;b=
a.parentNode;)a=b;return a},comparePoints:function(b,d,f,j){var h;if(b==f)return d===j?0:d<j?-1:1;else if(h=e(f,b,!0))return d<=a(h)?-1:1;else if(h=e(b,f,!0))return a(h)<j?-1:1;else if(d=c(b,f),b=b===d?d:e(b,d,!0),f=f===d?d:e(f,d,!0),b===f)throw Error("comparePoints got to case 4 and childA and childB are the same!");else{for(d=d.firstChild;d;){if(d===b)return-1;else if(d===f)return 1;d=d.nextSibling}throw Error("Should not be here!");}},inspectNode:k,createIterator:function(a){return new n(a)},DomPosition:m};
d.DOMException=s});
rangy.createModule("DomRange",function(d){function b(a,b){return a.nodeType!=3&&(l.isAncestorOf(a,b.startContainer,!0)||l.isAncestorOf(a,b.endContainer,!0))}function a(a){return l.getDocument(a.startContainer)}function c(a,b,c){if(b=a._listeners[b])for(var e=0,d=b.length;e<d;++e)b[e].call(a,{target:a,args:c})}function e(a){return new u(a.parentNode,l.getNodeIndex(a))}function f(a){return new u(a.parentNode,l.getNodeIndex(a)+1)}function g(a,b,c){var e=a.nodeType==11?a.firstChild:a;l.isCharacterDataNode(b)?
c==b.length?l.insertAfter(a,b):b.parentNode.insertBefore(a,c==0?b:l.splitDataNode(b,c)):c>=b.childNodes.length?b.appendChild(a):b.insertBefore(a,b.childNodes[c]);return e}function i(b){for(var c,e,d=a(b.range).createDocumentFragment();e=b.next();){c=b.isPartiallySelectedSubtree();e=e.cloneNode(!c);c&&(c=b.getSubtreeIterator(),e.appendChild(i(c)),c.detach(!0));if(e.nodeType==10)throw new C("HIERARCHY_REQUEST_ERR");d.appendChild(e)}return d}function k(a,b,c){for(var e,d,c=c||{stop:!1};e=a.next();)if(a.isPartiallySelectedSubtree())if(b(e)===
!1){c.stop=!0;break}else{if(e=a.getSubtreeIterator(),k(e,b,c),e.detach(!0),c.stop)break}else for(e=l.createIterator(e);d=e.next();)if(b(d)===!1){c.stop=!0;return}}function n(a){for(var b;a.next();)a.isPartiallySelectedSubtree()?(b=a.getSubtreeIterator(),n(b),b.detach(!0)):a.remove()}function m(b){for(var c,e=a(b.range).createDocumentFragment(),d;c=b.next();){b.isPartiallySelectedSubtree()?(c=c.cloneNode(!1),d=b.getSubtreeIterator(),c.appendChild(m(d)),d.detach(!0)):b.remove();if(c.nodeType==10)throw new C("HIERARCHY_REQUEST_ERR");
e.appendChild(c)}return e}function s(a,b,c){var e=!(!b||!b.length),d,t=!!c;e&&(d=RegExp("^("+b.join("|")+")$"));var f=[];k(new h(a,!1),function(a){(!e||d.test(a.nodeType))&&(!t||c(a))&&f.push(a)});return f}function o(a){return"["+(typeof a.getName=="undefined"?"Range":a.getName())+"("+l.inspectNode(a.startContainer)+":"+a.startOffset+", "+l.inspectNode(a.endContainer)+":"+a.endOffset+")]"}function h(a,b){this.range=a;this.clonePartiallySelectedTextNodes=b;if(!a.collapsed){this.sc=a.startContainer;
this.so=a.startOffset;this.ec=a.endContainer;this.eo=a.endOffset;var c=a.commonAncestorContainer;this.sc===this.ec&&l.isCharacterDataNode(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc===c&&!l.isCharacterDataNode(this.sc)?this.sc.childNodes[this.so]:l.getClosestAncestorIn(this.sc,c,!0),this._last=this.ec===c&&!l.isCharacterDataNode(this.ec)?this.ec.childNodes[this.eo-1]:l.getClosestAncestorIn(this.ec,c,!0))}}function r(a){this.code=
this[a];this.codeName=a;this.message="RangeException: "+this.codeName}function j(a,b,c){this.nodes=s(a,b,c);this._next=this.nodes[0];this._position=0}function p(a){return function(b,c){for(var e,d=c?b:b.parentNode;d;){e=d.nodeType;if(l.arrayContains(a,e))return d;d=d.parentNode}return null}}function x(a,b){if(Y(a,b))throw new r("INVALID_NODE_TYPE_ERR");}function q(a){if(!a.startContainer)throw new C("INVALID_STATE_ERR");}function w(a,b){if(!l.arrayContains(b,a.nodeType))throw new r("INVALID_NODE_TYPE_ERR");
}function E(a,b){if(b<0||b>(l.isCharacterDataNode(a)?a.length:a.childNodes.length))throw new C("INDEX_SIZE_ERR");}function B(a,b){if(L(a,!0)!==L(b,!0))throw new C("WRONG_DOCUMENT_ERR");}function z(a){if(Z(a,!0))throw new C("NO_MODIFICATION_ALLOWED_ERR");}function y(a,b){if(!a)throw new C(b);}function v(a){q(a);if(!l.arrayContains(I,a.startContainer.nodeType)&&!L(a.startContainer,!0)||!l.arrayContains(I,a.endContainer.nodeType)&&!L(a.endContainer,!0)||!(a.startOffset<=(l.isCharacterDataNode(a.startContainer)?
a.startContainer.length:a.startContainer.childNodes.length))||!(a.endOffset<=(l.isCharacterDataNode(a.endContainer)?a.endContainer.length:a.endContainer.childNodes.length)))throw Error("Range error: Range is no longer valid after DOM mutation ("+a.inspect()+")");}function G(){}function J(a){a.START_TO_START=Q;a.START_TO_END=T;a.END_TO_END=$;a.END_TO_START=U;a.NODE_BEFORE=V;a.NODE_AFTER=W;a.NODE_BEFORE_AND_AFTER=X;a.NODE_INSIDE=R}function H(a){J(a);J(a.prototype)}function F(a,b){return function(){v(this);
var c=this.startContainer,e=this.startOffset,d=this.commonAncestorContainer,t=new h(this,!0);if(c!==d)c=l.getClosestAncestorIn(c,d,!0),e=f(c),c=e.node,e=e.offset;k(t,z);t.reset();d=a(t);t.detach();b(this,c,e,c,e);return d}}function A(a,c,j){function A(a,b){return function(c){q(this);w(c,N);w(t(c),I);c=(a?e:f)(c);(b?k:g)(this,c.node,c.offset)}}function k(a,b,e){var d=a.endContainer,f=a.endOffset;if(b!==a.startContainer||e!==this.startOffset){if(t(b)!=t(d)||l.comparePoints(b,e,d,f)==1)d=b,f=e;c(a,b,
e,d,f)}}function g(a,b,e){var d=a.startContainer,f=a.startOffset;if(b!==a.endContainer||e!==this.endOffset){if(t(b)!=t(d)||l.comparePoints(b,e,d,f)==-1)d=b,f=e;c(a,d,f,b,e)}}function L(a,b,e){(b!==a.startContainer||e!==this.startOffset||b!==a.endContainer||e!==this.endOffset)&&c(a,b,e,b,e)}a.prototype=new G;d.util.extend(a.prototype,{setStart:function(a,b){q(this);x(a,!0);E(a,b);k(this,a,b)},setEnd:function(a,b){q(this);x(a,!0);E(a,b);g(this,a,b)},setStartBefore:A(!0,!0),setStartAfter:A(!1,!0),setEndBefore:A(!0,
!1),setEndAfter:A(!1,!1),collapse:function(a){v(this);a?c(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):c(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(a){q(this);x(a,!0);c(this,a,0,a,l.getNodeLength(a))},selectNode:function(a){q(this);x(a,!1);w(a,N);var b=e(a),a=f(a);c(this,b.node,b.offset,a.node,a.offset)},extractContents:F(m,c),deleteContents:F(n,c),canSurroundContents:function(){v(this);z(this.startContainer);
z(this.endContainer);var a=new h(this,!0),c=a._first&&b(a._first,this)||a._last&&b(a._last,this);a.detach();return!c},detach:function(){j(this)},splitBoundaries:function(){v(this);var a=this.startContainer,b=this.startOffset,e=this.endContainer,d=this.endOffset,t=a===e;l.isCharacterDataNode(e)&&d>0&&d<e.length&&l.splitDataNode(e,d);l.isCharacterDataNode(a)&&b>0&&b<a.length&&(a=l.splitDataNode(a,b),t?(d-=b,e=a):e==a.parentNode&&d>=l.getNodeIndex(a)&&d++,b=0);c(this,a,b,e,d)},normalizeBoundaries:function(){v(this);
var a=this.startContainer,b=this.startOffset,e=this.endContainer,d=this.endOffset,t=function(a){var b=a.nextSibling;if(b&&b.nodeType==a.nodeType)e=a,d=a.length,a.appendData(b.data),b.parentNode.removeChild(b)},f=function(c){var t=c.previousSibling;if(t&&t.nodeType==c.nodeType){a=c;var f=c.length;b=t.length;c.insertData(0,t.data);t.parentNode.removeChild(t);a==e?(d+=b,e=a):e==c.parentNode&&(t=l.getNodeIndex(c),d==t?(e=c,d=f):d>t&&d--)}},j=!0;l.isCharacterDataNode(e)?e.length==d&&t(e):(d>0&&(j=e.childNodes[d-
1])&&l.isCharacterDataNode(j)&&t(j),j=!this.collapsed);j?l.isCharacterDataNode(a)?b==0&&f(a):b<a.childNodes.length&&(t=a.childNodes[b])&&l.isCharacterDataNode(t)&&f(t):(a=e,b=d);c(this,a,b,e,d)},collapseToPoint:function(a,b){q(this);x(a,!0);E(a,b);L(this,a,b)}});H(a)}function O(a){a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset;a.commonAncestorContainer=a.collapsed?a.startContainer:l.getCommonAncestor(a.startContainer,a.endContainer)}function M(a,b,e,d,t){var f=a.startContainer!==
b||a.startOffset!==e,j=a.endContainer!==d||a.endOffset!==t;a.startContainer=b;a.startOffset=e;a.endContainer=d;a.endOffset=t;O(a);c(a,"boundarychange",{startMoved:f,endMoved:j})}function D(a){this.startContainer=a;this.startOffset=0;this.endContainer=a;this.endOffset=0;this._listeners={boundarychange:[],detach:[]};O(this)}d.requireModules(["DomUtil"]);var l=d.dom,u=l.DomPosition,C=d.DOMException;h.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=
null;this._next=this._first},hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next;if(a)this._next=a!==this._last?a.nextSibling:null,l.isCharacterDataNode(a)&&this.clonePartiallySelectedTextNodes&&(a===this.ec&&(a=a.cloneNode(!0)).deleteData(this.eo,a.length-this.eo),this._current===this.sc&&(a=a.cloneNode(!0)).deleteData(0,this.so));return a},remove:function(){var a=this._current,b,c;l.isCharacterDataNode(a)&&(a===this.sc||a===this.ec)?(b=a===this.sc?this.so:0,c=a===
this.ec?this.eo:a.length,b!=c&&a.deleteData(b,c-b)):a.parentNode&&a.parentNode.removeChild(a)},isPartiallySelectedSubtree:function(){return b(this._current,this.range)},getSubtreeIterator:function(){var b;if(this.isSingleCharacterDataNode)b=this.range.cloneRange(),b.collapse();else{b=new D(a(this.range));var c=this._current,e=c,d=0,t=c,f=l.getNodeLength(c);if(l.isAncestorOf(c,this.sc,!0))e=this.sc,d=this.so;if(l.isAncestorOf(c,this.ec,!0))t=this.ec,f=this.eo;M(b,e,d,t,f)}return new h(b,this.clonePartiallySelectedTextNodes)},
detach:function(a){a&&this.range.detach();this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};r.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2};r.prototype.toString=function(){return this.message};j.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){this._current=this._next;this._next=this.nodes[++this._position];return this._current},detach:function(){this._current=this._next=this.nodes=null}};var N=[1,3,4,5,
7,8,10],I=[2,9,11],P=[1,3,4,5,7,8,10,11],K=[1,3,4,5,7,8],t=l.getRootContainer,L=p([9,11]),Z=p([5,6,10,12]),Y=p([6,10,12]),S=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],Q=0,T=1,$=2,U=3,V=0,W=1,X=2,R=3;G.prototype={attachListener:function(a,b){this._listeners[a].push(b)},compareBoundaryPoints:function(a,b){v(this);B(this.startContainer,b.startContainer);var c=a==U||a==Q?"start":"end",e=a==T||a==Q?"start":"end";return l.comparePoints(this[c+"Container"],
this[c+"Offset"],b[e+"Container"],b[e+"Offset"])},insertNode:function(a){v(this);w(a,P);z(this.startContainer);if(l.isAncestorOf(a,this.startContainer,!0))throw new C("HIERARCHY_REQUEST_ERR");this.setStartBefore(g(a,this.startContainer,this.startOffset))},cloneContents:function(){v(this);var b,c;if(this.collapsed)return a(this).createDocumentFragment();else{if(this.startContainer===this.endContainer&&l.isCharacterDataNode(this.startContainer))return b=this.startContainer.cloneNode(!0),b.data=b.data.slice(this.startOffset,
this.endOffset),c=a(this).createDocumentFragment(),c.appendChild(b),c;else c=new h(this,!0),b=i(c),c.detach();return b}},canSurroundContents:function(){v(this);z(this.startContainer);z(this.endContainer);var a=new h(this,!0),c=a._first&&b(a._first,this)||a._last&&b(a._last,this);a.detach();return!c},surroundContents:function(a){w(a,K);if(!this.canSurroundContents())throw new r("BAD_BOUNDARYPOINTS_ERR");var b=this.extractContents();if(a.hasChildNodes())for(;a.lastChild;)a.removeChild(a.lastChild);
g(a,this.startContainer,this.startOffset);a.appendChild(b);this.selectNode(a)},cloneRange:function(){v(this);for(var b=new D(a(this)),c=S.length,e;c--;)e=S[c],b[e]=this[e];return b},toString:function(){v(this);var a=this.startContainer;if(a===this.endContainer&&l.isCharacterDataNode(a))return a.nodeType==3||a.nodeType==4?a.data.slice(this.startOffset,this.endOffset):"";else{var b=[],a=new h(this,!0);k(a,function(a){(a.nodeType==3||a.nodeType==4)&&b.push(a.data)});a.detach();return b.join("")}},compareNode:function(a){v(this);
var b=a.parentNode,c=l.getNodeIndex(a);if(!b)throw new C("NOT_FOUND_ERR");a=this.comparePoint(b,c);b=this.comparePoint(b,c+1);return a<0?b>0?X:V:b>0?W:R},comparePoint:function(a,b){v(this);y(a,"HIERARCHY_REQUEST_ERR");B(a,this.startContainer);if(l.comparePoints(a,b,this.startContainer,this.startOffset)<0)return-1;else if(l.comparePoints(a,b,this.endContainer,this.endOffset)>0)return 1;return 0},createContextualFragment:function(b){q(this);var c=a(this),e=c.createElement("div");e.innerHTML=b;for(b=
c.createDocumentFragment();c=e.firstChild;)b.appendChild(c);return b},toHtml:function(){v(this);var b=a(this).createElement("div");b.appendChild(this.cloneContents());return b.innerHTML},intersectsNode:function(b,c){v(this);y(b,"NOT_FOUND_ERR");if(l.getDocument(b)!==a(this))return!1;var e=b.parentNode,d=l.getNodeIndex(b);y(e,"NOT_FOUND_ERR");var t=l.comparePoints(e,d,this.endContainer,this.endOffset),e=l.comparePoints(e,d+1,this.startContainer,this.startOffset);return c?t<=0&&e>=0:t<0&&e>0},isPointInRange:function(a,
b){v(this);y(a,"HIERARCHY_REQUEST_ERR");B(a,this.startContainer);return l.comparePoints(a,b,this.startContainer,this.startOffset)>=0&&l.comparePoints(a,b,this.endContainer,this.endOffset)<=0},intersectsRange:function(b,c){v(this);if(a(b)!=a(this))throw new C("WRONG_DOCUMENT_ERR");var e=l.comparePoints(this.startContainer,this.startOffset,b.endContainer,b.endOffset),d=l.comparePoints(this.endContainer,this.endOffset,b.startContainer,b.startOffset);return c?e<=0&&d>=0:e<0&&d>0},intersection:function(a){if(this.intersectsRange(a)){var b=
l.comparePoints(this.startContainer,this.startOffset,a.startContainer,a.startOffset),c=l.comparePoints(this.endContainer,this.endOffset,a.endContainer,a.endOffset),e=this.cloneRange();b==-1&&e.setStart(a.startContainer,a.startOffset);c==1&&e.setEnd(a.endContainer,a.endOffset);return e}return null},union:function(a){if(this.intersectsRange(a,!0)){var b=this.cloneRange();l.comparePoints(a.startContainer,a.startOffset,this.startContainer,this.startOffset)==-1&&b.setStart(a.startContainer,a.startOffset);
l.comparePoints(a.endContainer,a.endOffset,this.endContainer,this.endOffset)==1&&b.setEnd(a.endContainer,a.endOffset);return b}else throw new r("Ranges do not intersect");},containsNode:function(a,b){return b?this.intersectsNode(a,!1):this.compareNode(a)==R},containsNodeContents:function(a){return this.comparePoint(a,0)>=0&&this.comparePoint(a,l.getNodeLength(a))<=0},containsRange:function(a){return this.intersection(a).equals(a)},containsNodeText:function(a){var b=this.cloneRange();b.selectNode(a);
var c=b.getNodes([3]);return c.length>0?(b.setStart(c[0],0),a=c.pop(),b.setEnd(a,a.length),a=this.containsRange(b),b.detach(),a):this.containsNodeContents(a)},createNodeIterator:function(a,b){v(this);return new j(this,a,b)},getNodes:function(a,b){v(this);return s(this,a,b)},getDocument:function(){return a(this)},collapseBefore:function(a){q(this);this.setEndBefore(a);this.collapse(!1)},collapseAfter:function(a){q(this);this.setStartAfter(a);this.collapse(!0)},getName:function(){return"DomRange"},
equals:function(a){return D.rangesEqual(this,a)},inspect:function(){return o(this)}};A(D,M,function(a){q(a);a.startContainer=a.startOffset=a.endContainer=a.endOffset=null;a.collapsed=a.commonAncestorContainer=null;c(a,"detach",null);a._listeners=null});d.rangePrototype=G.prototype;D.rangeProperties=S;D.RangeIterator=h;D.copyComparisonConstants=H;D.createPrototypeRange=A;D.inspect=o;D.getRangeDocument=a;D.rangesEqual=function(a,b){return a.startContainer===b.startContainer&&a.startOffset===b.startOffset&&
a.endContainer===b.endContainer&&a.endOffset===b.endOffset};d.DomRange=D;d.RangeException=r});
rangy.createModule("WrappedRange",function(d){function b(a,b,c,d){var g=a.duplicate();g.collapse(c);var h=g.parentElement();e.isAncestorOf(b,h,!0)||(h=b);if(!h.canHaveHTML)return new f(h.parentNode,e.getNodeIndex(h));var b=e.getDocument(h).createElement("span"),r,j=c?"StartToStart":"StartToEnd";do h.insertBefore(b,b.previousSibling),g.moveToElementText(b);while((r=g.compareEndPoints(j,a))>0&&b.previousSibling);j=b.nextSibling;if(r==-1&&j&&e.isCharacterDataNode(j)){g.setEndPoint(c?"EndToStart":"EndToEnd",
a);if(/[\r\n]/.test(j.data)){h=g.duplicate();c=h.text.replace(/\r\n/g,"\r").length;for(c=h.moveStart("character",c);h.compareEndPoints("StartToEnd",h)==-1;)c++,h.moveStart("character",1)}else c=g.text.length;h=new f(j,c)}else j=(d||!c)&&b.previousSibling,h=(c=(d||c)&&b.nextSibling)&&e.isCharacterDataNode(c)?new f(c,0):j&&e.isCharacterDataNode(j)?new f(j,j.length):new f(h,e.getNodeIndex(b));b.parentNode.removeChild(b);return h}function a(a,b){var c,d,f=a.offset,h=e.getDocument(a.node),g=h.body.createTextRange(),
j=e.isCharacterDataNode(a.node);j?(c=a.node,d=c.parentNode):(c=a.node.childNodes,c=f<c.length?c[f]:null,d=a.node);h=h.createElement("span");h.innerHTML="&#feff;";c?d.insertBefore(h,c):d.appendChild(h);g.moveToElementText(h);g.collapse(!b);d.removeChild(h);if(j)g[b?"moveStart":"moveEnd"]("character",f);return g}d.requireModules(["DomUtil","DomRange"]);var c,e=d.dom,f=e.DomPosition,g=d.DomRange;if(d.features.implementsDomRange&&(!d.features.implementsTextRange||!d.config.preferTextRange))(function(){function a(b){for(var c=
d.length,e;c--;)e=d[c],b[e]=b.nativeRange[e]}var b,d=g.rangeProperties,f;c=function(b){if(!b)throw Error("Range must be specified");this.nativeRange=b;a(this)};g.createPrototypeRange(c,function(a,b,c,e,d){var f=a.endContainer!==e||a.endOffset!=d;if(a.startContainer!==b||a.startOffset!=c||f)a.setEnd(e,d),a.setStart(b,c)},function(a){a.nativeRange.detach();a.detached=!0;for(var b=d.length,c;b--;)c=d[b],a[c]=null});b=c.prototype;b.selectNode=function(b){this.nativeRange.selectNode(b);a(this)};b.deleteContents=
function(){this.nativeRange.deleteContents();a(this)};b.extractContents=function(){var b=this.nativeRange.extractContents();a(this);return b};b.cloneContents=function(){return this.nativeRange.cloneContents()};b.surroundContents=function(b){this.nativeRange.surroundContents(b);a(this)};b.collapse=function(b){this.nativeRange.collapse(b);a(this)};b.cloneRange=function(){return new c(this.nativeRange.cloneRange())};b.refresh=function(){a(this)};b.toString=function(){return this.nativeRange.toString()};
var i=document.createTextNode("test");e.getBody(document).appendChild(i);var h=document.createRange();h.setStart(i,0);h.setEnd(i,0);try{h.setStart(i,1),b.setStart=function(b,c){this.nativeRange.setStart(b,c);a(this)},b.setEnd=function(b,c){this.nativeRange.setEnd(b,c);a(this)},f=function(b){return function(c){this.nativeRange[b](c);a(this)}}}catch(r){b.setStart=function(b,c){try{this.nativeRange.setStart(b,c)}catch(e){this.nativeRange.setEnd(b,c),this.nativeRange.setStart(b,c)}a(this)},b.setEnd=function(b,
c){try{this.nativeRange.setEnd(b,c)}catch(e){this.nativeRange.setStart(b,c),this.nativeRange.setEnd(b,c)}a(this)},f=function(b,c){return function(e){try{this.nativeRange[b](e)}catch(d){this.nativeRange[c](e),this.nativeRange[b](e)}a(this)}}}b.setStartBefore=f("setStartBefore","setEndBefore");b.setStartAfter=f("setStartAfter","setEndAfter");b.setEndBefore=f("setEndBefore","setStartBefore");b.setEndAfter=f("setEndAfter","setStartAfter");h.selectNodeContents(i);b.selectNodeContents=h.startContainer==
i&&h.endContainer==i&&h.startOffset==0&&h.endOffset==i.length?function(b){this.nativeRange.selectNodeContents(b);a(this)}:function(a){this.setStart(a,0);this.setEnd(a,g.getEndOffset(a))};h.selectNodeContents(i);h.setEnd(i,3);f=document.createRange();f.selectNodeContents(i);f.setEnd(i,4);f.setStart(i,2);b.compareBoundaryPoints=h.compareBoundaryPoints(h.START_TO_END,f)==-1&h.compareBoundaryPoints(h.END_TO_START,f)==1?function(a,b){b=b.nativeRange||b;if(a==b.START_TO_END)a=b.END_TO_START;else if(a==
b.END_TO_START)a=b.START_TO_END;return this.nativeRange.compareBoundaryPoints(a,b)}:function(a,b){return this.nativeRange.compareBoundaryPoints(a,b.nativeRange||b)};e.getBody(document).removeChild(i);h.detach();f.detach()})(),d.createNativeRange=function(a){return(a||document).createRange()};else if(d.features.implementsTextRange){c=function(a){this.textRange=a;this.refresh()};c.prototype=new g(document);c.prototype.refresh=function(){var a,c,d=this.textRange;a=d.parentElement();var f=d.duplicate();
f.collapse(!0);c=f.parentElement();f=d.duplicate();f.collapse(!1);d=f.parentElement();c=c==d?c:e.getCommonAncestor(c,d);c=c==a?c:e.getCommonAncestor(a,c);this.textRange.compareEndPoints("StartToEnd",this.textRange)==0?c=a=b(this.textRange,c,!0,!0):(a=b(this.textRange,c,!0,!1),c=b(this.textRange,c,!1,!1));this.setStart(a.node,a.offset);this.setEnd(c.node,c.offset)};g.copyComparisonConstants(c);var i=function(){return this}();if(typeof i.Range=="undefined")i.Range=c;d.createNativeRange=function(a){return(a||
document).body.createTextRange()}}if(d.features.implementsTextRange)c.rangeToTextRange=function(b){if(b.collapsed)return a(new f(b.startContainer,b.startOffset),!0);else{var c=a(new f(b.startContainer,b.startOffset),!0),d=a(new f(b.endContainer,b.endOffset),!1),b=e.getDocument(b.startContainer).body.createTextRange();b.setEndPoint("StartToStart",c);b.setEndPoint("EndToEnd",d);return b}};c.prototype.getName=function(){return"WrappedRange"};d.WrappedRange=c;d.createRange=function(a){return new c(d.createNativeRange(a||
document))};d.createRangyRange=function(a){return new g(a||document)};d.createIframeRange=function(a){return d.createRange(e.getIframeDocument(a))};d.createIframeRangyRange=function(a){return d.createRangyRange(e.getIframeDocument(a))};d.addCreateMissingNativeApiListener(function(a){a=a.document;if(typeof a.createRange=="undefined")a.createRange=function(){return d.createRange(this)};a=a=null})});
rangy.createModule("WrappedSelection",function(d,b){function a(a){return(a||window).getSelection()}function c(a){return(a||window).document.selection}function e(a,b,c){var e=c?"end":"start",c=c?"start":"end";a.anchorNode=b[e+"Container"];a.anchorOffset=b[e+"Offset"];a.focusNode=b[c+"Container"];a.focusOffset=b[c+"Offset"]}function f(a){a.anchorNode=a.focusNode=null;a.anchorOffset=a.focusOffset=0;a.rangeCount=0;a.isCollapsed=!0;a._ranges.length=0}function g(a){var b;if(a instanceof x){if(b=a._selectionNativeRange,
!b)b=d.createNativeRange(j.getDocument(a.startContainer)),b.setEnd(a.endContainer,a.endOffset),b.setStart(a.startContainer,a.startOffset),a._selectionNativeRange=b,a.attachListener("detach",function(){this._selectionNativeRange=null})}else a instanceof q?b=a.nativeRange:d.features.implementsDomRange&&a instanceof j.getWindow(a.startContainer).Range&&(b=a);return b}function i(a){var b=a.getNodes(),c;a:if(!b.length||b[0].nodeType!=1)c=!1;else{c=1;for(var e=b.length;c<e;++c)if(!j.isAncestorOf(b[0],b[c])){c=
!1;break a}c=!0}if(!c)throw Error("getSingleElementFromRange: range "+a.inspect()+" did not consist of a single element");return b[0]}function k(a,b){var c=new q(b);a._ranges=[c];e(a,c,!1);a.rangeCount=1;a.isCollapsed=c.collapsed}function n(a){a._ranges.length=0;if(a.docSelection.type=="None")f(a);else{var b=a.docSelection.createRange();if(b&&typeof b.text!="undefined")k(a,b);else{a.rangeCount=b.length;for(var c,A=j.getDocument(b.item(0)),h=0;h<a.rangeCount;++h)c=d.createRange(A),c.selectNode(b.item(h)),
a._ranges.push(c);a.isCollapsed=a.rangeCount==1&&a._ranges[0].collapsed;e(a,a._ranges[a.rangeCount-1],!1)}}}function m(a,b){for(var c=a.docSelection.createRange(),e=i(b),d=j.getDocument(c.item(0)),d=j.getBody(d).createControlRange(),f=0,A=c.length;f<A;++f)d.add(c.item(f));try{d.add(e)}catch(h){throw Error("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)");}d.select();n(a)}function s(a,b,c){this.nativeSelection=a;this.docSelection=b;this._ranges=
[];this.win=c;this.refresh()}function o(a,b){for(var c=j.getDocument(b[0].startContainer),c=j.getBody(c).createControlRange(),e=0,d;e<rangeCount;++e){d=i(b[e]);try{c.add(d)}catch(f){throw Error("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)");}}c.select();n(a)}function h(a,b){if(a.anchorNode&&j.getDocument(a.anchorNode)!==j.getDocument(b))throw new w("WRONG_DOCUMENT_ERR");}function r(a){var b=[],c=new E(a.anchorNode,a.anchorOffset),
e=new E(a.focusNode,a.focusOffset),d=typeof a.getName=="function"?a.getName():"Selection";if(typeof a.rangeCount!="undefined")for(var f=0,A=a.rangeCount;f<A;++f)b[f]=x.inspect(a.getRangeAt(f));return"["+d+"(Ranges: "+b.join(", ")+")(anchor: "+c.inspect()+", focus: "+e.inspect()+"]"}d.requireModules(["DomUtil","DomRange","WrappedRange"]);d.config.checkSelectionRanges=!0;var j=d.dom,p=d.util,x=d.DomRange,q=d.WrappedRange,w=d.DOMException,E=j.DomPosition,B,z,y=d.util.isHostMethod(window,"getSelection"),
v=d.util.isHostObject(document,"selection"),G=v&&(!y||d.config.preferTextRange);G?(B=c,d.isSelectionValid=function(a){var a=(a||window).document,b=a.selection;return b.type!="None"||j.getDocument(b.createRange().parentElement())==a}):y?(B=a,d.isSelectionValid=function(){return!0}):b.fail("Neither document.selection or window.getSelection() detected.");d.getNativeSelection=B;var y=B(),J=d.createNativeRange(document),H=j.getBody(document),F=p.areHostObjects(y,p.areHostProperties(y,["anchorOffset","focusOffset"]));
d.features.selectionHasAnchorAndFocus=F;var A=p.isHostMethod(y,"extend");d.features.selectionHasExtend=A;var O=typeof y.rangeCount=="number";d.features.selectionHasRangeCount=O;var M=!1,D=!0;p.areHostMethods(y,["addRange","getRangeAt","removeAllRanges"])&&typeof y.rangeCount=="number"&&d.features.implementsDomRange&&function(){var a=document.createElement("iframe");H.appendChild(a);var b=j.getIframeDocument(a);b.open();b.write("<html><head></head><body>12</body></html>");b.close();var c=j.getIframeWindow(a).getSelection(),
e=b.documentElement.lastChild.firstChild,b=b.createRange();b.setStart(e,1);b.collapse(!0);c.addRange(b);D=c.rangeCount==1;c.removeAllRanges();var d=b.cloneRange();b.setStart(e,0);d.setEnd(e,2);c.addRange(b);c.addRange(d);M=c.rangeCount==2;b.detach();d.detach();H.removeChild(a)}();d.features.selectionSupportsMultipleRanges=M;d.features.collapsedNonEditableSelectionsSupported=D;var l=!1,u;H&&p.isHostMethod(H,"createControlRange")&&(u=H.createControlRange(),p.areHostProperties(u,["item","add"])&&(l=
!0));d.features.implementsControlRange=l;z=F?function(a){return a.anchorNode===a.focusNode&&a.anchorOffset===a.focusOffset}:function(a){return a.rangeCount?a.getRangeAt(a.rangeCount-1).collapsed:!1};var C;p.isHostMethod(y,"getRangeAt")?C=function(a,b){try{return a.getRangeAt(b)}catch(c){return null}}:F&&(C=function(a){var b=j.getDocument(a.anchorNode),b=d.createRange(b);b.setStart(a.anchorNode,a.anchorOffset);b.setEnd(a.focusNode,a.focusOffset);b.collapsed!==this.isCollapsed&&(b.setStart(a.focusNode,
a.focusOffset),b.setEnd(a.anchorNode,a.anchorOffset));return b});d.getSelection=function(a){var a=a||window,b=a._rangySelection,e=B(a),d=v?c(a):null;b?(b.nativeSelection=e,b.docSelection=d,b.refresh(a)):(b=new s(e,d,a),a._rangySelection=b);return b};d.getIframeSelection=function(a){return d.getSelection(j.getIframeWindow(a))};u=s.prototype;if(!G&&F&&p.areHostMethods(y,["removeAllRanges","addRange"])){u.removeAllRanges=function(){this.nativeSelection.removeAllRanges();f(this)};var N=function(a,b){var c=
x.getRangeDocument(b),c=d.createRange(c);c.collapseToPoint(b.endContainer,b.endOffset);a.nativeSelection.addRange(g(c));a.nativeSelection.extend(b.startContainer,b.startOffset);a.refresh()};u.addRange=O?function(a,b){if(l&&v&&this.docSelection.type=="Control")m(this,a);else if(b&&A)N(this,a);else{var c;M?c=this.rangeCount:(this.removeAllRanges(),c=0);this.nativeSelection.addRange(g(a));this.rangeCount=this.nativeSelection.rangeCount;this.rangeCount==c+1?(d.config.checkSelectionRanges&&(c=C(this.nativeSelection,
this.rangeCount-1))&&!x.rangesEqual(c,a)&&(a=new q(c)),this._ranges[this.rangeCount-1]=a,e(this,a,K(this.nativeSelection)),this.isCollapsed=z(this)):this.refresh()}}:function(a,b){b&&A?N(this,a):(this.nativeSelection.addRange(g(a)),this.refresh())};u.setRanges=function(a){if(l&&a.length>1)o(this,a);else{this.removeAllRanges();for(var b=0,c=a.length;b<c;++b)this.addRange(a[b])}}}else if(p.isHostMethod(y,"empty")&&p.isHostMethod(J,"select")&&l&&G)u.removeAllRanges=function(){try{if(this.docSelection.empty(),
this.docSelection.type!="None"){var a;if(this.anchorNode)a=j.getDocument(this.anchorNode);else if(this.docSelection.type=="Control"){var b=this.docSelection.createRange();b.length&&(a=j.getDocument(b.item(0)).body.createTextRange())}a&&(a.body.createTextRange().select(),this.docSelection.empty())}}catch(c){}f(this)},u.addRange=function(a){this.docSelection.type=="Control"?m(this,a):(q.rangeToTextRange(a).select(),this._ranges[0]=a,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,e(this,
a,!1))},u.setRanges=function(a){this.removeAllRanges();var b=a.length;b>1?o(this,a):b&&this.addRange(a[0])};else return b.fail("No means of selecting a Range or TextRange was found"),!1;u.getRangeAt=function(a){if(a<0||a>=this.rangeCount)throw new w("INDEX_SIZE_ERR");else return this._ranges[a]};var I;if(G)I=function(a){var b;d.isSelectionValid(a.win)?b=a.docSelection.createRange():(b=j.getBody(a.win.document).createTextRange(),b.collapse(!0));a.docSelection.type=="Control"?n(a):b&&typeof b.text!=
"undefined"?k(a,b):f(a)};else if(p.isHostMethod(y,"getRangeAt")&&typeof y.rangeCount=="number")I=function(a){if(l&&v&&a.docSelection.type=="Control")n(a);else if(a._ranges.length=a.rangeCount=a.nativeSelection.rangeCount,a.rangeCount){for(var b=0,c=a.rangeCount;b<c;++b)a._ranges[b]=new d.WrappedRange(a.nativeSelection.getRangeAt(b));e(a,a._ranges[a.rangeCount-1],K(a.nativeSelection));a.isCollapsed=z(a)}else f(a)};else if(F&&typeof y.isCollapsed=="boolean"&&typeof J.collapsed=="boolean"&&d.features.implementsDomRange)I=
function(a){var b;b=a.nativeSelection;b.anchorNode?(b=C(b,0),a._ranges=[b],a.rangeCount=1,b=a.nativeSelection,a.anchorNode=b.anchorNode,a.anchorOffset=b.anchorOffset,a.focusNode=b.focusNode,a.focusOffset=b.focusOffset,a.isCollapsed=z(a)):f(a)};else return b.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;u.refresh=function(a){var b=a?this._ranges.slice(0):null;I(this);if(a){a=b.length;if(a!=this._ranges.length)return!1;for(;a--;)if(!x.rangesEqual(b[a],this._ranges[a]))return!1;
return!0}};var P=function(a,b){var c=a.getAllRanges(),e=!1;a.removeAllRanges();for(var d=0,A=c.length;d<A;++d)e||b!==c[d]?a.addRange(c[d]):e=!0;a.rangeCount||f(a)};u.removeRange=l?function(a){if(this.docSelection.type=="Control"){for(var b=this.docSelection.createRange(),a=i(a),c=j.getDocument(b.item(0)),c=j.getBody(c).createControlRange(),e,d=!1,f=0,A=b.length;f<A;++f)e=b.item(f),e!==a||d?c.add(b.item(f)):d=!0;c.select();n(this)}else P(this,a)}:function(a){P(this,a)};var K;!G&&F&&d.features.implementsDomRange?
(K=function(a){var b=!1;a.anchorNode&&(b=j.comparePoints(a.anchorNode,a.anchorOffset,a.focusNode,a.focusOffset)==1);return b},u.isBackwards=function(){return K(this)}):K=u.isBackwards=function(){return!1};u.toString=function(){for(var a=[],b=0,c=this.rangeCount;b<c;++b)a[b]=""+this._ranges[b];return a.join("")};u.collapse=function(a,b){h(this,a);var c=d.createRange(j.getDocument(a));c.collapseToPoint(a,b);this.removeAllRanges();this.addRange(c);this.isCollapsed=!0};u.collapseToStart=function(){if(this.rangeCount){var a=
this._ranges[0];this.collapse(a.startContainer,a.startOffset)}else throw new w("INVALID_STATE_ERR");};u.collapseToEnd=function(){if(this.rangeCount){var a=this._ranges[this.rangeCount-1];this.collapse(a.endContainer,a.endOffset)}else throw new w("INVALID_STATE_ERR");};u.selectAllChildren=function(a){h(this,a);var b=d.createRange(j.getDocument(a));b.selectNodeContents(a);this.removeAllRanges();this.addRange(b)};u.deleteFromDocument=function(){if(l&&v&&this.docSelection.type=="Control"){for(var a=this.docSelection.createRange(),
b;a.length;)b=a.item(0),a.remove(b),b.parentNode.removeChild(b);this.refresh()}else if(this.rangeCount){a=this.getAllRanges();this.removeAllRanges();b=0;for(var c=a.length;b<c;++b)a[b].deleteContents();this.addRange(a[c-1])}};u.getAllRanges=function(){return this._ranges.slice(0)};u.setSingleRange=function(a){this.setRanges([a])};u.containsNode=function(a,b){for(var c=0,e=this._ranges.length;c<e;++c)if(this._ranges[c].containsNode(a,b))return!0;return!1};u.toHtml=function(){var a="";if(this.rangeCount){for(var a=
x.getRangeDocument(this._ranges[0]).createElement("div"),b=0,c=this._ranges.length;b<c;++b)a.appendChild(this._ranges[b].cloneContents());a=a.innerHTML}return a};u.getName=function(){return"WrappedSelection"};u.inspect=function(){return r(this)};u.detach=function(){this.win=this.anchorNode=this.focusNode=this.win._rangySelection=null};s.inspect=r;d.Selection=s;d.selectionPrototype=u;d.addCreateMissingNativeApiListener(function(a){if(typeof a.getSelection=="undefined")a.getSelection=function(){return d.getSelection(this)};
a=null})});
rangy.createModule("CssClassApplier",function(d,b){function a(a,b){return a.className&&RegExp("(?:^|\\s)"+b+"(?:\\s|$)").test(a.className)}function c(b,c){b.className?a(b,c)||(b.className+=" "+c):b.className=c}function e(a){return a.split(/\s+/).sort().join(" ")}function f(a,b){return e(a.className)==e(b.className)}function g(a){for(var b=a.parentNode;a.hasChildNodes();)b.insertBefore(a.firstChild,a);b.removeChild(a)}function i(a,b){var c=a.cloneRange();c.selectNodeContents(b);var e=c.intersection(a),e=
e?e.toString():"";c.detach();return e!=""}function k(a){return a.getNodes([3],function(b){return i(a,b)})}function n(a,b){if(a.attributes.length!=b.attributes.length)return!1;for(var c=0,e=a.attributes.length,d,f;c<e;++c)if(d=a.attributes[c],f=d.name,f!="class"){f=b.attributes.getNamedItem(f);if(d.specified!=f.specified)return!1;if(d.specified&&d.nodeValue!==f.nodeValue)return!1}return!0}function m(a,b){for(var c=0,e=a.attributes.length,d;c<e;++c)if(d=a.attributes[c].name,(!b||!w.arrayContains(b,
d))&&a.attributes[c].specified&&d!="class")return!0;return!1}function s(a){var b;return a&&a.nodeType==1&&((b=a.parentNode)&&b.nodeType==9&&b.designMode=="on"||z(a)&&!z(a.parentNode))}function o(a){return(z(a)||a.nodeType!=1&&z(a.parentNode))&&!s(a)}function h(a){return a&&a.nodeType==1&&!y.test(B(a,"display"))}function r(a){if(a.data.length==0)return!0;if(v.test(a.data))return!1;switch(B(a.parentNode,"whiteSpace")){case "pre":case "pre-wrap":case "-moz-pre-wrap":return!1;case "pre-line":if(/[\r\n]/.test(a.data))return!1}return h(a.previousSibling)||
h(a.nextSibling)}function j(a,c,e,d){var f,h=e==0;if(w.isAncestorOf(c,a))throw b.createError("descendant is ancestor of node");if(w.isCharacterDataNode(c))if(e==0)e=w.getNodeIndex(c),c=c.parentNode;else if(e==c.length)e=w.getNodeIndex(c)+1,c=c.parentNode;else throw b.createError("splitNodeAt should not be called with offset in the middle of a data node ("+e+" in "+c.data);if(w.isCharacterDataNode(c)?e==0?c.previousSibling:e==c.length?c.nextSibling:1:e>0&&e<c.childNodes.length){if(!f){f=c.cloneNode(!1);
for(f.id&&f.removeAttribute("id");h=c.childNodes[e];)f.appendChild(h);w.insertAfter(f,c)}return c==a?f:j(a,f.parentNode,w.getNodeIndex(f),d)}else if(a!=c)return f=c.parentNode,c=w.getNodeIndex(c),h||c++,j(a,f,c,d);return a}function p(a){var b=a?"nextSibling":"previousSibling";return function(c,e){var d=c.parentNode,h=c[b];if(h){if(h&&h.nodeType==3)return h}else if(e&&(h=d[b])&&h.nodeType==1&&d.tagName==h.tagName&&f(d,h)&&n(d,h))return h[a?"firstChild":"lastChild"];return null}}function x(a){this.firstTextNode=
(this.isElementMerge=a.nodeType==1)?a.lastChild:a;this.textNodes=[this.firstTextNode]}function q(a,b,c){this.cssClass=a;var d,f,h=null;if(typeof b=="object"&&b!==null){c=b.tagNames;h=b.elementProperties;for(d=0;f=H[d++];)b.hasOwnProperty(f)&&(this[f]=b[f]);d=b.normalize}else d=b;this.normalize=typeof d=="undefined"?!0:d;this.attrExceptions=[];d=document.createElement(this.elementTagName);this.elementProperties={};for(var g in h)h.hasOwnProperty(g)&&(F.hasOwnProperty(g)&&(g=F[g]),d[g]=h[g],this.elementProperties[g]=
d[g],this.attrExceptions.push(g));this.elementSortedClassName=this.elementProperties.hasOwnProperty("className")?e(this.elementProperties.className+" "+a):a;this.applyToAnyTagName=!1;a=typeof c;if(a=="string")c=="*"?this.applyToAnyTagName=!0:this.tagNames=c.toLowerCase().replace(/^\s\s*/,"").replace(/\s\s*$/,"").split(/\s*,\s*/);else if(a=="object"&&typeof c.length=="number"){this.tagNames=[];d=0;for(a=c.length;d<a;++d)c[d]=="*"?this.applyToAnyTagName=!0:this.tagNames.push(c[d].toLowerCase())}else this.tagNames=
[this.elementTagName]}d.requireModules(["WrappedSelection","WrappedRange"]);var w=d.dom,E=function(){function a(b,c,e){return c&&e?" ":""}return function(b,c){if(b.className)b.className=b.className.replace(RegExp("(?:^|\\s)"+c+"(?:\\s|$)"),a)}}(),B;typeof window.getComputedStyle!="undefined"?B=function(a,b){return w.getWindow(a).getComputedStyle(a,null)[b]}:typeof document.documentElement.currentStyle!="undefined"?B=function(a,b){return a.currentStyle[b]}:b.fail("No means of obtaining computed style properties found");
var z;(function(){z=typeof document.createElement("div").isContentEditable=="boolean"?function(a){return a&&a.nodeType==1&&a.isContentEditable}:function(a){return!a||a.nodeType!=1||a.contentEditable=="false"?!1:a.contentEditable=="true"||z(a.parentNode)}})();var y=/^inline(-block|-table)?$/i,v=/[^\r\n\t\f \u200B]/,G=p(!1),J=p(!0);x.prototype={doMerge:function(){for(var a=[],b,c,e=0,d=this.textNodes.length;e<d;++e)b=this.textNodes[e],c=b.parentNode,a[e]=b.data,e&&(c.removeChild(b),c.hasChildNodes()||
c.parentNode.removeChild(c));return this.firstTextNode.data=a=a.join("")},getLength:function(){for(var a=this.textNodes.length,b=0;a--;)b+=this.textNodes[a].length;return b},toString:function(){for(var a=[],b=0,c=this.textNodes.length;b<c;++b)a[b]="'"+this.textNodes[b].data+"'";return"[Merge("+a.join(",")+")]"}};var H=["elementTagName","ignoreWhiteSpace","applyToEditableOnly"],F={"class":"className"};q.prototype={elementTagName:"span",elementProperties:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,
hasClass:function(b){return b.nodeType==1&&w.arrayContains(this.tagNames,b.tagName.toLowerCase())&&a(b,this.cssClass)},getSelfOrAncestorWithClass:function(a){for(;a;){if(this.hasClass(a,this.cssClass))return a;a=a.parentNode}return null},isModifiable:function(a){return!this.applyToEditableOnly||o(a)},isIgnorableWhiteSpaceNode:function(a){return this.ignoreWhiteSpace&&a&&a.nodeType==3&&r(a)},postApply:function(a,b,c){for(var e=a[0],d=a[a.length-1],f=[],h,g=e,j=d,k=0,i=d.length,r,m,p=0,n=a.length;p<
n;++p)if(r=a[p],m=G(r,!c)){h||(h=new x(m),f.push(h));h.textNodes.push(r);if(r===e)g=h.firstTextNode,k=g.length;if(r===d)j=h.firstTextNode,i=h.getLength()}else h=null;if(a=J(d,!c))h||(h=new x(d),f.push(h)),h.textNodes.push(a);if(f.length){p=0;for(n=f.length;p<n;++p)f[p].doMerge();b.setStart(g,k);b.setEnd(j,i)}},createContainer:function(a){a=a.createElement(this.elementTagName);d.util.extend(a,this.elementProperties);c(a,this.cssClass);return a},applyToTextNode:function(a){var b=a.parentNode;b.childNodes.length==
1&&w.arrayContains(this.tagNames,b.tagName.toLowerCase())?c(b,this.cssClass):(b=this.createContainer(w.getDocument(a)),a.parentNode.insertBefore(b,a),b.appendChild(a))},isRemovable:function(a){var b;if(b=a.tagName.toLowerCase()==this.elementTagName)if(b=e(a.className)==this.elementSortedClassName){var c;a:{b=this.elementProperties;for(c in b)if(b.hasOwnProperty(c)&&a[c]!==b[c]){c=!1;break a}c=!0}b=c&&!m(a,this.attrExceptions)&&this.isModifiable(a)}return b},undoToTextNode:function(a,b,c){b.containsNode(c)||
(a=b.cloneRange(),a.selectNode(c),a.isPointInRange(b.endContainer,b.endOffset)&&(j(c,b.endContainer,b.endOffset,[b]),b.setEndAfter(c)),a.isPointInRange(b.startContainer,b.startOffset)&&(c=j(c,b.startContainer,b.startOffset,[b])));this.isRemovable(c)?g(c):E(c,this.cssClass)},applyToRange:function(a){a.splitBoundaries();var b=k(a);if(b.length){for(var c,e=0,d=b.length;e<d;++e)c=b[e],!this.isIgnorableWhiteSpaceNode(c)&&!this.getSelfOrAncestorWithClass(c)&&this.isModifiable(c)&&this.applyToTextNode(c);
a.setStart(b[0],0);c=b[b.length-1];a.setEnd(c,c.length);this.normalize&&this.postApply(b,a,!1)}},applyToSelection:function(a){var a=d.getSelection(a||window),b,c=a.getAllRanges();a.removeAllRanges();for(var e=c.length;e--;)b=c[e],this.applyToRange(b),a.addRange(b)},undoToRange:function(a){a.splitBoundaries();var b=k(a),c,e,d=b[b.length-1];if(b.length){for(var f=0,h=b.length;f<h;++f)c=b[f],(e=this.getSelfOrAncestorWithClass(c))&&this.isModifiable(c)&&this.undoToTextNode(c,a,e),a.setStart(b[0],0),a.setEnd(d,
d.length);this.normalize&&this.postApply(b,a,!0)}},undoToSelection:function(a){var a=d.getSelection(a||window),b=a.getAllRanges(),c;a.removeAllRanges();for(var e=0,f=b.length;e<f;++e)c=b[e],this.undoToRange(c),a.addRange(c)},getTextSelectedByRange:function(a,b){var c=b.cloneRange();c.selectNodeContents(a);var e=c.intersection(b),e=e?e.toString():"";c.detach();return e},isAppliedToRange:function(a){if(a.collapsed)return!!this.getSelfOrAncestorWithClass(a.commonAncestorContainer);else{for(var b=a.getNodes([3]),
c=0,e;e=b[c++];)if(!this.isIgnorableWhiteSpaceNode(e)&&i(a,e)&&this.isModifiable(e)&&!this.getSelfOrAncestorWithClass(e))return!1;return!0}},isAppliedToSelection:function(a){for(var a=d.getSelection(a||window).getAllRanges(),b=a.length;b--;)if(!this.isAppliedToRange(a[b]))return!1;return!0},toggleRange:function(a){this.isAppliedToRange(a)?this.undoToRange(a):this.applyToRange(a)},toggleSelection:function(a){this.isAppliedToSelection(a)?this.undoToSelection(a):this.applyToSelection(a)},detach:function(){}};
q.util={hasClass:a,addClass:c,removeClass:E,hasSameClasses:f,replaceWithOwnChildren:g,elementsHaveSameNonClassAttributes:n,elementHasNonClassAttributes:m,splitNodeAt:j,isEditableElement:z,isEditingHost:s,isEditable:o};d.CssClassApplier=q;d.createCssClassApplier=function(a,b,c){return new q(a,b,c)}});
rangy.createModule("SaveRestore",function(d,b){function a(a,b){var c="selectionBoundary_"+ +new Date+"_"+(""+Math.random()).slice(2),e,d=g.getDocument(a.startContainer),f=a.cloneRange();f.collapse(b);e=d.createElement("span");e.id=c;e.style.lineHeight="0";e.style.display="none";e.className="rangySelectionBoundary";e.appendChild(d.createTextNode(i));f.insertNode(e);f.detach();return e}function c(a,c,e,d){(a=(a||document).getElementById(e))?(c[d?"setStartBefore":"setEndBefore"](a),a.parentNode.removeChild(a)):
b.warn("Marker element has been removed. Cannot restore selection.")}function e(a,b){return b.compareBoundaryPoints(a.START_TO_START,a)}function f(a,b){var c=(a||document).getElementById(b);c&&c.parentNode.removeChild(c)}d.requireModules(["DomUtil","DomRange","WrappedRange"]);var g=d.dom,i="\ufeff";d.saveSelection=function(c){var c=c||window,f=c.document;if(d.isSelectionValid(c)){var g=d.getSelection(c),i=g.getAllRanges(),o=[],h,r;i.sort(e);for(var j=0,p=i.length;j<p;++j)h=i[j],h.collapsed?(r=a(h,
!1),o.push({markerId:r.id,collapsed:!0})):(r=a(h,!1),h=a(h,!0),o[j]={startMarkerId:h.id,endMarkerId:r.id,collapsed:!1,backwards:i.length==1&&g.isBackwards()});for(j=p-1;j>=0;--j)h=i[j],h.collapsed?h.collapseBefore((f||document).getElementById(o[j].markerId)):(h.setEndBefore((f||document).getElementById(o[j].endMarkerId)),h.setStartAfter((f||document).getElementById(o[j].startMarkerId)));g.setRanges(i);return{win:c,doc:f,rangeInfos:o,restored:!1}}else b.warn("Cannot save selection. This usually happens when the selection is collapsed and the selection document has lost focus.")};
d.restoreSelection=function(a,e){if(!a.restored){for(var f=a.rangeInfos,g=d.getSelection(a.win),i=[],h=f.length,r=h-1,j,p;r>=0;--r){j=f[r];p=d.createRange(a.doc);if(j.collapsed)if(j=(a.doc||document).getElementById(j.markerId)){j.style.display="inline";var x=j.previousSibling;x&&x.nodeType==3?(j.parentNode.removeChild(j),p.collapseToPoint(x,x.length)):(p.collapseBefore(j),j.parentNode.removeChild(j))}else b.warn("Marker element has been removed. Cannot restore selection.");else c(a.doc,p,j.startMarkerId,
!0),c(a.doc,p,j.endMarkerId,!1);h==1&&p.normalizeBoundaries();i[r]=p}h==1&&e&&d.features.selectionHasExtend&&f[0].backwards?(g.removeAllRanges(),g.addRange(i[0],!0)):g.setRanges(i);a.restored=!0}};d.removeMarkerElement=f;d.removeMarkers=function(a){for(var b=a.rangeInfos,c=0,e=b.length,d;c<e;++c)d=b[c],d.collapsed?f(a.doc,d.markerId):(f(a.doc,d.startMarkerId),f(a.doc,d.endMarkerId))}});
rangy.createModule("Serializer",function(d,b){function a(b,c){var c=c||[],e=b.nodeType,d=b.childNodes,f=d.length,g=[e,b.nodeName,f].join(":"),i="",k="";switch(e){case 3:i=b.nodeValue.replace(/</g,"&lt;").replace(/>/g,"&gt;");break;case 8:i="<\!--"+b.nodeValue.replace(/</g,"&lt;").replace(/>/g,"&gt;")+"--\>";break;default:i="<"+g+">",k="</>"}i&&c.push(i);for(e=0;e<f;++e)a(d[e],c);k&&c.push(k);return c}function c(b){b=a(b).join("");return s(b).toString(16)}function e(a,b,c){for(var e=[],d=a,c=c||o.getDocument(a).documentElement;d&&
d!=c;)e.push(o.getNodeIndex(d,!0)),d=d.parentNode;return e.join("/")+":"+b}function f(a,c,e){c?e||o.getDocument(c):c=(e||document).documentElement;for(var a=a.split(":"),e=a[0]?a[0].split("/"):[],d=e.length,f;d--;)if(f=parseInt(e[d],10),f<c.childNodes.length)c=c.childNodes[parseInt(e[d],10)];else throw b.createError("deserializePosition failed: node "+o.inspectNode(c)+" has no child with index "+f+", "+d);return new o.DomPosition(c,parseInt(a[1],10))}function g(a,b,f){f=f||d.DomRange.getRangeDocument(a).documentElement;
if(!o.isAncestorOf(f,a.commonAncestorContainer,!0))throw Error("serializeRange: range is not wholly contained within specified root node");a=e(a.startContainer,a.startOffset,f)+","+e(a.endContainer,a.endOffset,f);b||(a+="{"+c(f)+"}");return a}function i(a,b,e){b?e=e||o.getDocument(b):(e=e||document,b=e.documentElement);var a=/^([^,]+),([^,\{]+)({([^}]+)})?$/.exec(a),g=a[4],i=c(b);if(g&&g!==c(b))throw Error("deserializeRange: checksums of serialized range root node ("+g+") and target root node ("+
i+") do not match");g=f(a[1],b,e);b=f(a[2],b,e);e=d.createRange(e);e.setStart(g.node,g.offset);e.setEnd(b.node,b.offset);return e}function k(a,b,e){b?e||o.getDocument(b):b=(e||document).documentElement;a=/^([^,]+),([^,]+)({([^}]+)})?$/.exec(a)[3];return!a||a===c(b)}function n(a,b,c){for(var a=a||d.getSelection(),a=a.getAllRanges(),e=[],f=0,i=a.length;f<i;++f)e[f]=g(a[f],b,c);return e.join("|")}function m(a,b,c){b?c=c||o.getWindow(b):(c=c||window,b=c.document.documentElement);for(var a=a.split("|"),
e=d.getSelection(c),f=[],g=0,k=a.length;g<k;++g)f[g]=i(a[g],b,c.document);e.setRanges(f);return e}d.requireModules(["WrappedSelection","WrappedRange"]);(typeof encodeURIComponent=="undefined"||typeof decodeURIComponent=="undefined")&&b.fail("Global object is missing encodeURIComponent and/or decodeURIComponent method");var s=function(){var a=null;return function(b){for(var c=[],e=0,d=b.length,f;e<d;++e)f=b.charCodeAt(e),f<128?c.push(f):f<2048?c.push(f>>6|192,f&63|128):c.push(f>>12|224,f>>6&63|128,
f&63|128);b=-1;if(!a){for(var e=[],d=0,g;d<256;++d){g=d;for(f=8;f--;)(g&1)==1?g=g>>>1^3988292384:g>>>=1;e[d]=g>>>0}a=e}e=a;d=0;for(f=c.length;d<f;++d)g=(b^c[d])&255,b=b>>>8^e[g];return(b^-1)>>>0}}(),o=d.dom;d.serializePosition=e;d.deserializePosition=f;d.serializeRange=g;d.deserializeRange=i;d.canDeserializeRange=k;d.serializeSelection=n;d.deserializeSelection=m;d.canDeserializeSelection=function(a,b,c){var e;b?e=c?c.document:o.getDocument(b):b=(c||window).document.documentElement;for(var a=a.split("|"),
c=0,d=a.length;c<d;++c)if(!k(a[c],b,e))return!1;return!0};d.restoreSelectionFromCookie=function(a){var a=a||window,b;a:{b=a.document.cookie.split(/[;,]/);for(var c=0,e=b.length,d;c<e;++c)if(d=b[c].split("="),d[0].replace(/^\s+/,"")=="rangySerializedSelection"&&(d=d[1])){b=decodeURIComponent(d.replace(/\s+$/,""));break a}b=null}b&&m(b,a.doc)};d.saveSelectionCookie=function(a,b){var a=a||window,b=typeof b=="object"?b:{},c=b.expires?";expires="+b.expires.toUTCString():"",e=b.path?";path="+b.path:"",
f=b.domain?";domain="+b.domain:"",g=b.secure?";secure":"",i=n(d.getSelection(a));a.document.cookie=encodeURIComponent("rangySerializedSelection")+"="+encodeURIComponent(i)+c+e+f+g};d.getElementChecksum=c});
(function(){var d,b;d={changeIdAttribute:"data-cid",userIdAttribute:"data-userid",userNameAttribute:"data-username",timeAttribute:"data-time",attrValuePrefix:"",blockEl:"p",stylePrefix:"cts",currentUser:{id:null,name:null},changeTypes:{insertType:{tag:"insert",alias:"ins",action:"Inserted"},deleteType:{tag:"delete",alias:"del",action:"Deleted"}},handleEvents:!1,contentEditable:!0,isTracking:!0,doNotTrack:"span#test",avoid:".ice-avoid"};b=function(a){a||(a={});if(!a.element)throw Error("`options.element` must be defined for ice construction.");
ice.dom.extend(!0,this,d,a);this.pluginsManager=new ice.IcePluginManager(this);a.plugins&&this.pluginsManager.usePlugins("ice-init",a.plugins)};b.prototype={_changes:{},_userStyles:{},_styles:{},_uniqueStyleIndex:0,_browserType:null,_batchChangeid:null,_uniqueIDIndex:1,_delBookmark:"tempdel",isPlaceHoldingDeletes:!1,startTracking:function(){this.element.setAttribute("contentEditable",this.contentEditable);if(this.handleEvents){var a=this;ice.dom.bind(a.element,"keyup keydown keypress mousedown mouseup",
function(b){return a.handleEvent(b)})}this.initializeEnvironment();this.initializeEditor();this.initializeRange();this.pluginsManager.fireEnabled(this.element);return this},initializeEnvironment:function(){this.env||(this.env={});this.env.element=this.element;this.env.document=this.element.ownerDocument;this.env.window=this.env.document.defaultView||this.env.document.parentWindow||window;this.env.frame=this.env.window.frameElement;this.env.selection=this.selection=new ice.Selection(this.env)},initializeRange:function(){var a=
this.selection.createRange();a.setStart(ice.dom.find(this.element,this.blockEl)[0],0);a.collapse(!0);this.selection.addRange(a);this.env.frame?this.env.frame.contentWindow.focus():this.element.focus()},initializeEditor:function(){var a=this,b=this.env.document.createElement("div");this.element.childNodes.length?(ice.dom.each(ice.dom.contents(this.element),function(a,e){ice.dom.isBlockElement(e)&&b.appendChild(e)}),b.innerHTML===""&&b.appendChild(ice.dom.create("<"+this.blockEl+" ><br/></"+this.blockEl+
">"))):b.appendChild(ice.dom.create("<"+this.blockEl+" ><br/></"+this.blockEl+">"));this.element.innerHTML=b.innerHTML;var e=this._getIceNodeClass("insertType"),d=this._getIceNodeClass("deleteType");ice.dom.each(ice.dom.find(this.element,"."+e+",."+d),function(b,c){for(var k=0,n="",m=c.className.split(" "),b=0;b<m.length;b++){var s=RegExp(a.stylePrefix+"-(\\d+)").exec(m[b]);s&&(k=s[1]);(s=RegExp("("+e+"|"+d+")").exec(m[b]))&&(n=a._getChangeTypeFromAlias(s[1]))}m=ice.dom.attr(c,a.userIdAttribute);
a.setUserStyle(m,Number(k));k=ice.dom.attr(c,a.changeIdAttribute);a._changes[k]={type:n,userid:m,username:ice.dom.attr(c,a.userNameAttribute),time:ice.dom.attr(c,a.timeAttribute)}})},enableChangeTracking:function(){this.isTracking=!0;this.pluginsManager.fireEnabled(this.element)},disableChangeTracking:function(){this.isTracking=!1;this.pluginsManager.fireDisabled(this.element)},setCurrentUser:function(a){this.currentUser=a},handleEvent:function(a){if(this.isTracking)if(a.type=="mouseup"){var b=this;
setTimeout(function(){b.mouseUp(a)},200)}else if(a.type=="mousedown")return this.mouseDown(a);else if(a.type=="keypress"){var e=this.keyPress(a);e||a.preventDefault();return e}else if(a.type=="keydown")return(e=this.keyDown(a))||a.preventDefault(),e;else a.type=="keyup"&&this.pluginsManager.fireCaretUpdated()},createIceNode:function(a,b){var e=this.env.document.createElement(this.changeTypes[a].tag);ice.dom.addClass(e,this._getIceNodeClass(a));e.appendChild(b?b:this.env.document.createTextNode(""));
this.addChange(this.changeTypes[a].alias,[e]);this.pluginsManager.fireNodeCreated(e,{action:this.changeTypes[a].action});return e},insert:function(a,b){b?this.selection.addRange(b):b=this.getCurrentRange();typeof a==="string"&&(a=document.createTextNode(a));if(!b.collapsed&&(this.deleteContents(),b=this.getCurrentRange(),b.startContainer===b.endContainer&&this.element===b.startContainer)){ice.dom.empty(this.element);var e=b.getLastSelectableChild(this.element);b.setStartAfter(e);b.collapse(!0)}this._moveRangeToValidTrackingPos(b);
e=this.startBatchChange();this._insertNode(a||document.createTextNode("\ufeff"),b,!a);this.pluginsManager.fireNodeInserted(a,b);this.endBatchChange(e);return!0},placeholdDeletes:function(){var a=this;this.isPlaceholdingDeletes&&this.revertDeletePlaceholders();this.isPlaceholdingDeletes=!0;this._deletes=[];var b="."+this._getIceNodeClass("deleteType");ice.dom.each(ice.dom.find(this.element,b),function(b,c){a._deletes.push(ice.dom.cloneNode(c));ice.dom.replaceWith(c,"<"+a._delBookmark+' data-allocation="'+
(a._deletes.length-1)+'"/>')});return!0},revertDeletePlaceholders:function(){var a=this;if(!this.isPlaceholdingDeletes)return!1;ice.dom.each(this._deletes,function(b,e){ice.dom.find(a.element,a._delBookmark+"[data-allocation="+b+"]").replaceWith(e)});this.isPlaceholdingDeletes=!1;return!0},deleteContents:function(a,b){var e=!0;b?this.selection.addRange(b):b=this.getCurrentRange();var d=this.startBatchChange(this.changeTypes.deleteType.alias);b.collapsed===!1?this._deleteFromSelection(b):e=a?this._deleteFromRight(b):
this._deleteFromLeft(b);this.selection.addRange(b);this.endBatchChange(d);return e},getChanges:function(){return this._changes},getElementContent:function(){return this.element.innerHTML},getCleanContent:function(a,b){var e="",d=this;ice.dom.each(this.changeTypes,function(a,b){a!="deleteType"&&(b>0&&(e+=","),e+="."+d._getIceNodeClass(a))});var a=a?typeof a==="string"?ice.dom.create("<div>"+a+"</div>"):ice.dom.cloneNode(a)[0]:ice.dom.cloneNode(this.element)[0],g=ice.dom.find(a,e);ice.dom.each(g,function(){ice.dom.replaceWith(this,
ice.dom.contents(this))});g=ice.dom.find(a,"."+this._getIceNodeClass("deleteType"));ice.dom.remove(g);a=b?b.call(this,a):a;return a.innerHTML},acceptAll:function(){this.element.innerHTML=this.getCleanContent()},rejectAll:function(){var a="."+this._getIceNodeClass("insertType"),b="."+this._getIceNodeClass("deleteType");ice.dom.remove(ice.dom.find(this.element,a));ice.dom.each(ice.dom.find(this.element,b),function(a,b){ice.dom.replaceWith(b,ice.dom.contents(b))})},acceptChange:function(a){this.acceptRejectChange(a,
!0)},rejectChange:function(a){this.acceptRejectChange(a,!1)},acceptRejectChange:function(a,b){var e,d,g,i,k,n,m=ice.dom;if(!a)if(e=this.getCurrentRange(),e.collapsed)a=e.startContainer;else return;e=g="."+this._getIceNodeClass("deleteType");d=i="."+this._getIceNodeClass("insertType");k=m.getNode(a,e+","+d);n=m.find(this.element,"["+this.changeIdAttribute+"="+m.attr(k,this.changeIdAttribute)+"]");b||(g=d,i=e);ice.dom.is(k,i)?m.each(n,function(a,b){m.replaceWith(b,ice.dom.contents(b))}):m.is(k,g)&&
m.remove(n)},isInsideChange:function(a){var b="."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType");if(!a)if(range=this.getCurrentRange(),range.collapsed)a=range.startContainer;else return!1;return!!ice.dom.getNode(a,b)},addChangeType:function(a,b,e){this.changeTypes[a]={tag:b,alias:e}},getIceNode:function(a,b){var e="."+this._getIceNodeClass(b);return ice.dom.getNode(a,e)},_moveRangeToValidTrackingPos:function(a){for(var b=!1,e=this._getVoidElement(a.endContainer);e;){try{a.moveEnd(ice.dom.CHARACTER_UNIT,
1),a.moveEnd(ice.dom.CHARACTER_UNIT,-1)}catch(d){b=!0}if(b||ice.dom.onBlockBoundary(a.endContainer,a.startContainer,this.blockEl)){a.setStartAfter(e);a.collapse(!0);break}(e=this._getVoidElement(a.endContainer))?(a.setEnd(a.endContainer,0),a.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeTextContent(a.endContainer).length),a.collapse()):(a.setStart(a.endContainer,0),a.collapse(!0))}},_getVoidElement:function(a){var b=this._getVoidElSelector();return ice.dom.is(a,b)?a:ice.dom.parents(a,b)[0]||null},
_getVoidElSelector:function(){return"."+this._getIceNodeClass("deleteType")+","+this.avoid},_currentUserIceNode:function(a){return ice.dom.attr(a,this.userIdAttribute)==this.currentUser.id},_getChangeTypeFromAlias:function(a){var b,e=null;for(b in this.changeTypes)this.changeTypes.hasOwnProperty(b)&&this.changeTypes[b].alias==a&&(e=b);return e},_getIceNodeClass:function(a){return this.attrValuePrefix+this.changeTypes[a].alias},getUserStyle:function(a){var b=null;return b=this._userStyles[a]?this._userStyles[a]:
this.setUserStyle(a,this.getNewStyleId())},setUserStyle:function(a,b){var e=this.stylePrefix+"-"+b;this._styles[b]||(this._styles[b]=!0);return this._userStyles[a]=e},getNewStyleId:function(){var a=++this._uniqueStyleIndex;return this._styles[a]?this.getNewStyleId():(this._styles[a]=!0,a)},addChange:function(a,b){var e=this._batchChangeid||this.getNewChangeId();this._changes[e]||(this._changes[e]={type:this._getChangeTypeFromAlias(a),time:(new Date).getTime(),userid:this.currentUser.id,username:this.currentUser.name});
var d=this;ice.dom.foreach(b,function(a){d.addNodeToChange(e,b[a])});return e},addNodeToChange:function(a,b){if(this._batchChangeid!==null)a=this._batchChangeid;var e=this.getChange(a);b.getAttribute(this.changeIdAttribute)||b.setAttribute(this.changeIdAttribute,a);b.getAttribute(this.userIdAttribute)||b.setAttribute(this.userIdAttribute,e.userid);b.getAttribute(this.userNameAttribute)||b.setAttribute(this.userNameAttribute,e.username);b.getAttribute(this.timeAttribute)||b.setAttribute(this.timeAttribute,
e.time);ice.dom.hasClass(b,this._getIceNodeClass(e.type))||ice.dom.addClass(b,this._getIceNodeClass(e.type));e=this.getUserStyle(e.userid);ice.dom.hasClass(b,e)||ice.dom.addClass(b,e)},getChange:function(a){var b=null;this._changes[a]&&(b=this._changes[a]);return b},getNewChangeId:function(){var a=++this._uniqueIDIndex;this._changes[a]&&(a=this.getNewChangeId());return a},startBatchChange:function(){return this._batchChangeid=this.getNewChangeId()},endBatchChange:function(a){if(a===this._batchChangeid)this._batchChangeid=
null},getCurrentRange:function(){return this.selection.getRangeAt(0)},_insertNode:function(a,b,e){var d=this._currentUserIceNode(this.getIceNode(b.startContainer,"insertType"));if(!e||!d)d||(a=this.createIceNode("insertType",a)),b.insertNode(a),e&&(b.setStart(a,0),b.setEnd(a,1)),this.selection.addRange(b)},_deleteFromSelection:function(a){for(var b=new ice.Bookmark(this.env,a),e=ice.dom.getElementsBetween(b.start,b.end),d=ice.dom.parents(a.startContainer,this.blockEl)[0],g=ice.dom.parents(a.endContainer,
this.blockEl)[0],i=[],k=e.length,k=e.length,n=0;n<k;n++){var m=e[n];ice.dom.is(m,this.blockEl)&&i.push(m);if(!(m.nodeType===ice.dom.TEXT_NODE&&ice.dom.getNodeTextContent(m)==="")&&!this._getVoidElement(m)){if(m.nodeType!==ice.dom.TEXT_NODE){ice.dom.remove(ice.dom.find(m,"br"));var s=ice.dom.cloneNode(m);ice.dom.remove(ice.dom.find(s,this._getVoidElSelector()));if(ice.dom.getNodeTextContent(s).length===0)continue;else if(ice.dom.is(m,this.blockEl)){s=this.createIceNode("deleteType");newEl=document.createElement(this.blockEl);
s.innerHTML=m.innerHTML;m.innerHTML="";m.appendChild(s);continue}}s=this.createIceNode("deleteType");ice.dom.insertBefore(m,s);s.appendChild(m)}}if(d!==g){for(;i.length;)ice.dom.mergeContainers(i.shift(),d);ice.dom.mergeContainers(g,d)}(e=b.start.previousSibling)?(b.selectBookmark(),a=this.getCurrentRange(),a.moveStart(ice.dom.CHARACTER_UNIT,-1),a.moveStart(ice.dom.CHARACTER_UNIT,1)):(e=this.env.document.createTextNode(""),ice.dom.insertBefore(b.start,e),this.selection.addRange(a),b.selectBookmark(),
a=this.getCurrentRange(),a.setStart(e,0));a.collapse(!0)},_deleteFromRight:function(a){var b=ice.dom.parents(a.startContainer,this.blockEl)[0]||ice.dom.is(a.startContainer,this.blockEl)&&a.startContainer||null,e=b&&b.nextSibling||null,d=ice.dom.is(a.startContainer,this.blockEl)&&ice.dom.getNodeTextContent(a.startContainer)=="";a.moveEnd(ice.dom.CHARACTER_UNIT,1);a.moveEnd(ice.dom.CHARACTER_UNIT,-1);if(!e&&!ice.dom.isChildOf(a.endContainer,this.element))return a.moveEnd(ice.dom.CHARACTER_UNIT,-1),
a.moveEnd(ice.dom.CHARACTER_UNIT,1),a.collapse(),!0;if(ice.dom.onBlockBoundary(a.endContainer,a.startContainer,this.blockEl)||d)return e!==ice.dom.parents(a.endContainer,this.blockEl)[0]&&a.setEnd(e,0),ice.dom.remove(ice.dom.find(a.startContainer,"br")),ice.dom.mergeBlockWithSibling(a,ice.dom.parents(a.startContainer,this.blockEl)[0]||b,!0);if(this._getVoidElement(a.endContainer))return a.setEnd(a.endContainer,0),a.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeTextContent(a.endContainer).length||
0),a.collapse(),this._deleteFromRight(a);a.collapse();b=a.startContainer;if(a.startContainer.data&&a.endOffset===b.data.length){e=a.cloneRange();e.moveEnd(ice.dom.CHARACTER_UNIT,1);if(d=ice.dom.getBlockParent(e.endContainer,this.element)){if(ice.dom.isChildOf(d,this.element)===!1)return;var g=ice.dom.getBlockParent(e.startContainer,this.element);if(d!==g){ice.dom.mergeContainers(d,g);a.setStart(e.startContainer,e.startContainer.data.length);a.collapse(!0);return}}b=a.getNextContainer(b);if(ice.dom.isChildOf(b,
this.element)===!1)return!1;b=a.getFirstSelectableChild(b);a.setStart(b,0);this._addTextNodeTracking(b,a)}else if(b=this.getIceNode(a.startContainer,"insertType"),b===null||!this._currentUserIceNode(b))this._addTextNodeTracking(a.startContainer,a,!0);else if(a.moveEnd(ice.dom.CHARACTER_UNIT,1),a.deleteContents(),b!==null&&ice.dom.isBlank(ice.dom.getNodeTextContent(b))===!0){e=b.previousSibling;if(!e||e.nodeType!==ice.dom.TEXT_NODE)e=this.env.document.createTextNode(""),ice.dom.insertBefore(b,e);a.setStart(e,
e.data.length);ice.dom.remove(b)}a.collapse(!0);return!0},_deleteFromLeft:function(a){var b=ice.dom.parents(a.startContainer,this.blockEl)[0]||ice.dom.is(a.startContainer,this.blockEl)&&a.startContainer||null,e=b&&b.previousSibling||null,d=ice.dom.is(a.startContainer,this.blockEl)&&ice.dom.getNodeTextContent(a.startContainer)=="";a.moveStart(ice.dom.CHARACTER_UNIT,-1);var g=a.startOffset===a.endOffset&&a.startContainer===a.endContainer,i=!ice.dom.isChildOf(a.startContainer,this.element);a.moveStart(ice.dom.CHARACTER_UNIT,
1);if(g||!e&&i)return a.moveStart(ice.dom.CHARACTER_UNIT,1),a.moveStart(ice.dom.CHARACTER_UNIT,-1),a.collapse(!0),!0;if(ice.dom.onBlockBoundary(a.startContainer,a.endContainer,this.blockEl)||d)return e!==ice.dom.parents(a.startContainer,this.blockEl)[0]&&a.setStart(e,0),ice.dom.remove(ice.dom.find(a.endContainer,"br")),ice.dom.mergeBlockWithSibling(a,ice.dom.parents(a.endContainer,this.blockEl)[0]||b);if(this._getVoidElement(a.startContainer))return a.setStart(a.startContainer,0),a.collapse(!0),this._deleteFromLeft(a);
b=a.startContainer;if(a.startOffset===0){e=a.cloneRange();e.moveStart(ice.dom.CHARACTER_UNIT,-1);if(d=ice.dom.getBlockParent(e.startContainer,this.element)){if(ice.dom.isChildOf(d,this.element)===!1)return!1;g=ice.dom.getBlockParent(e.endContainer,this.element);if(g!==d){ice.dom.mergeContainers(g,d);a.setStart(e.startContainer,e.startContainer.data.length);a.collapse(!0);return}}b=a.getPreviousContainer(b);if(!ice.dom.isChildOf(b,this.element))return!1;ice.dom.isStubElement(b)?(a.moveStart(ice.dom.CHARACTER_UNIT,
-1),ice.dom.addClass(b,this._getIceNodeClass("deleteType")),ice.dom.attr(b,"title","Content removed"),a.collapse(!0)):(b=a.getLastSelectableChild(b),a.setStart(b,b.data.length),this._addTextNodeTracking(b,a))}else e=a.startContainer,b=this.getIceNode(e,"insertType"),b===null||!this._currentUserIceNode(b)?this._addTextNodeTracking(e,a):(a.moveStart(ice.dom.CHARACTER_UNIT,-1),a.moveEnd(ice.dom.CHARACTER_UNIT,-1),a.moveEnd(ice.dom.CHARACTER_UNIT,1),a.deleteContents(),b!==null&&ice.dom.isBlank(ice.dom.getNodeTextContent(b))&&
(e=this.env.document.createTextNode(""),ice.dom.insertBefore(b,e),a.setStart(e,0),a.collapse(!0),ice.dom.replaceWith(b,ice.dom.contents(b))));return!0},_addTextNodeTracking:function(a,b,e){if(!(!e&&b.startOffset===0||this.getIceNode(a,"deleteType")!==null)){var d="",g="",i="";e?(d=a.nodeValue.substring(0,b.endOffset),g=a.nodeValue.substr(b.endOffset,1),i=a.nodeValue.substring(b.endOffset+1)):(d=a.nodeValue.substring(0,b.startOffset-1),g=a.nodeValue.substr(b.startOffset-1,1),i=a.nodeValue.substring(b.startOffset));
if(b.startOffset===1&&!e||e&&b.startOffset===0){var k=this.getIceNode(a.previousSibling,"deleteType");k!==null&&!this._currentUserIceNode(k)&&(k=null);if(k){if(e)if(k.lastChild&&k.lastChild.nodeType===ice.dom.TEXT_NODE?k.lastChild.nodeValue+=g:(e=this.env.document.createTextNode(g),k.appendChild(e)),a.nodeValue=d+i,a.nodeValue.length===0){e=!1;for(a=a.nextSibling;!e;)(k=this.getIceNode(a,"deleteType"))?a=a.nextSibling:e=!0;a&&(b.setStart(a,0),b.collapse(!0))}else b.setStart(a,0),b.collapse(!0);else if(k.lastChild&&
k.lastChild.nodeType===ice.dom.TEXT_NODE?(k.lastChild.nodeValue+=g,b.setStart(k.lastChild,k.lastChild.nodeValue.length-1)):(e=this.env.document.createTextNode(g),k.appendChild(e),b.setStart(e,0)),a.nodeValue=d+i,a.nodeValue=d+i,a.nodeValue.length===0){e=!1;for(a=a.previousSibling;!e;)(k=this.getIceNode(a,"deleteType"))?a=a.previousSibling:e=!0;a&&(a=b.getLastSelectableChild(a),b.setStart(a,a.nodeValue.length),b.collapse(!0))}else b.collapse(!0);return}}if(b.startOffset===a.nodeValue.length&&(k=this.getIceNode(a.nextSibling,
"deleteType"),k!==null&&!this._currentUserIceNode(k)&&(k=null),k)){k.firstChild&&k.firstChild.nodeType===ice.dom.TEXT_NODE?k.firstChild.nodeValue=g+k.firstChild.nodeValue:(e=this.env.document.createTextNode(g),ice.dom.insertBefore(k.firstChild,e));a.nodeValue=d;b.setStart(a,a.nodeValue.length);b.setEnd(a,a.nodeValue.length);return}k=this.createIceNode("deleteType");d=null;e!==!0?(d=a.splitText(b.startOffset-1),d.nodeValue=d.nodeValue.substring(1),ice.dom.insertAfter(a,d),k.firstChild.nodeValue=g,
ice.dom.insertAfter(a,k),b.setStart(a,a.nodeValue.length),b.setEnd(a,a.nodeValue.length)):(d=a.splitText(b.endOffset),d.nodeValue=d.nodeValue.substring(1),ice.dom.insertAfter(a,d),k.firstChild.nodeValue=g,ice.dom.insertAfter(a,k),b.setStart(d,0),b.setEnd(d,0))}},_handleAncillaryKey:function(a){var b=!0;switch(a.keyCode){case ice.dom.DOM_VK_DELETE:b=this.deleteContents();this.pluginsManager.fireKeyPressed(a);break;case 46:b=this.deleteContents(!0);this.pluginsManager.fireKeyPressed(a);break;case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:case ice.dom.DOM_VK_RIGHT:this.pluginsManager.fireCaretPositioned();
b=!1;break;default:b=!1}return b===!0?(ice.dom.preventDefault(a),!1):!0},keyDown:function(a){if(!this.pluginsManager.fireKeyDown(a))return ice.dom.preventDefault(a),!1;var b=!1;if(this._handleSpecialKey(a)===!1){if(ice.dom.isBrowser("msie")!==!0)this._preventKeyPress=!0;return!1}else if((a.ctrlKey===!0||a.metaKey===!0)&&(ice.dom.isBrowser("msie")===!0||ice.dom.isBrowser("chrome")===!0)&&!this.pluginsManager.fireKeyPressed(a))return!1;switch(a.keyCode){case 27:break;default:/Firefox/.test(navigator.userAgent)!==
!0&&(b=!this._handleAncillaryKey(a))}return b?(ice.dom.preventDefault(a),!1):!0},keyPress:function(a){if(this._preventKeyPress===!0)this._preventKeyPress=!1;else{if(!this.pluginsManager.fireKeyPressed(a))return!1;var b=null;a.which==null?b=String.fromCharCode(a.keyCode):a.which>0&&(b=String.fromCharCode(a.which));var e=this.getCurrentRange(),d=ice.dom.parents(e.startContainer,"br")[0]||null;d&&(e.moveToNextEl(d),d.parentNode.removeChild(d));if(b!==null&&a.ctrlKey!==!0&&a.metaKey!==!0)switch(a.keyCode){case ice.dom.DOM_VK_DELETE:break;
case ice.dom.DOM_VK_ENTER:return this._handleEnter();default:return this._moveRangeToValidTrackingPos(e,e.startContainer),this.insert()}return this._handleAncillaryKey(a)}},_handleEnter:function(){this.getCurrentRange().collapsed||this.deleteContents();return!0},_handleSpecialKey:function(a){var b=a.which;if(b===null)b=a.keyCode;var e=!1;switch(b){case 65:if(a.ctrlKey===!0||a.metaKey===!0){e=!0;b=this.getCurrentRange();if(ice.dom.isBrowser("msie")===!0){var d=this.env.document.createTextNode(""),
g=this.env.document.createTextNode("");this.element.firstChild?ice.dom.insertBefore(this.element.firstChild,d):this.element.appendChild(d);this.element.appendChild(g);b.setStart(d,0);b.setEnd(g,0)}else b.setStart(b.getFirstSelectableChild(this.element),0),d=b.getLastSelectableChild(this.element),b.setEnd(d,d.length);this.selection.addRange(b)}}return e===!0?(ice.dom.preventDefault(a),!1):!0},mouseUp:function(a){if(!this.pluginsManager.fireClicked(a))return!1;this.pluginsManager.fireSelectionChanged(this.getCurrentRange())},
mouseDown:function(a){if(!this.pluginsManager.fireMouseDown(a))return!1;this.pluginsManager.fireCaretUpdated()}};this.ice=this.ice||{};this.ice.InlineChangeEditor=b}).call(this);
(function(){var d={DOM_VK_DELETE:8,DOM_VK_LEFT:37,DOM_VK_UP:38,DOM_VK_RIGHT:39,DOM_VK_DOWN:40,DOM_VK_ENTER:13,ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12,CHARACTER_UNIT:"character",WORD_UNIT:"word",getKeyChar:function(b){return String.fromCharCode(b.which)},getClass:function(b,a,c){if(!a)a=document.body;b="."+b.split(" ").join(".");
c&&(b=c+b);return jQuery.makeArray(jQuery(a).find(b))},getId:function(b,a){a||(a=document);return element=a.getElementById(b)},getTag:function(b,a){a||(a=document);return jQuery.makeArray(jQuery(a).find(b))},getElementWidth:function(b){return b.offsetWidth},getElementHeight:function(b){return b.offsetHeight},getElementDimensions:function(b){return{width:d.getElementWidth(b),height:d.getElementHeight(b)}},trim:function(b){return jQuery.trim(b)},empty:function(b){if(b)return jQuery(b).empty()},remove:function(b){if(b)return jQuery(b).remove()},
prepend:function(b,a){jQuery(b).prepend(a)},append:function(b,a){jQuery(b).append(a)},insertBefore:function(b,a){jQuery(b).before(a)},insertAfter:function(b,a){jQuery(b).after(a)},getHtml:function(b){return jQuery(b).html()},setHtml:function(b,a){b&&jQuery(b).html(a)},contents:function(b){return jQuery(b).contents()},extractContent:function(b){for(var a=document.createDocumentFragment(),c;c=b.firstChild;)a.appendChild(c);return a}};d.getNode=function(b,a){return d.is(b,a)?b:d.parents(b,a)[0]||null};
d.getParents=function(b,a,c){for(var b=jQuery(b).parents(a),a=b.length,e=[],d=0;d<a;d++){if(b[d]===c)break;e.push(b[d])}return e};d.hasBlockChildren=function(b){for(var a=b.childNodes.length,c=0;c<a;c++)if(b.childNodes[c].nodeType===d.ELEMENT_NODE&&d.isBlockElement(b.childNodes[c])===!0)return!0;return!1};d.removeTag=function(b,a){jQuery(b).find(a).replaceWith(function(){return jQuery(this).contents()});return b};d.stripEnclosingTags=function(b,a){var c=jQuery(b);c.find("*").not(a).replaceWith(function(){return jQuery(this).contents()});
return c[0]};d.getSiblings=function(b,a,c,e){if(c===!0)return a==="prev"?jQuery(b).prevAll():jQuery(b).nextAll();else{c=[];if(a==="prev")for(;b.previousSibling;){b=b.previousSibling;if(b===e)break;c.push(b)}else for(;b.nextSibling;){b=b.nextSibling;if(b===e)break;c.push(b)}return c}};d.getNodeTextContent=function(b){return jQuery(b).text()};d.setNodeTextContent=function(b,a){return jQuery(b).text(a)};d.getTagName=function(b){return b.tagName&&b.tagName.toLowerCase()||null};d.getIframeDocument=function(b){var a=
null;if(b.contentDocument)a=b.contentDocument;else if(b.contentWindow)a=b.contentWindow.document;else if(b.document)a=b.document;return a};d.isBlockElement=function(b){switch(b.nodeName.toLowerCase()){case "p":case "div":case "pre":case "ul":case "ol":case "li":case "table":case "tbody":case "td":case "th":case "fieldset":case "form":case "blockquote":case "dl":case "dir":case "center":case "address":case "h1":case "h2":case "h3":case "h4":case "h5":case "h6":case "img":return!0;default:return!1}};
d.isStubElement=function(b){if(b)switch(b.nodeName.toLowerCase()){case "img":case "br":case "hr":case "iframe":case "param":case "link":case "meta":case "input":case "frame":case "col":case "base":case "area":return!0}return!1};d.isChildOf=function(b,a){try{for(;b&&b.parentNode;){if(b.parentNode===a)return!0;b=b.parentNode}}catch(c){}return!1};d.isChildOfTagName=function(b,a){var c=null;try{for(;b&&b.parentNode;){if(b.parentNode&&b.parentNode.tagName&&b.parentNode.tagName.toLowerCase()===a)c=b.parentNode;
b=b.parentNode}}catch(e){}return c};d.isChildOfClassName=function(b,a){var c=null;try{for(;b&&b.parentNode;){if(jQuery(b.parentNode).hasClass(a))c=b.parentNode;b=b.parentNode}}catch(e){}return c};d.cloneNode=function(b,a){a===void 0&&(a=!0);return jQuery(b).clone(a)};d.bind=function(b,a,c){return jQuery(b).bind(a,c)};d.attr=function(b,a,c){return c?jQuery(b).attr(a,c):jQuery(b).attr(a)};d.replaceWith=function(b,a){return jQuery(b).replaceWith(a)};d.removeAttr=function(b,a){jQuery(b).removeAttr(a)};
d.getElementsBetween=function(b,a){var c=[];if(b===a)return c;if(d.isChildOf(a,b)===!0){for(var e=b.childNodes.length,f=0;f<e;f++)if(b.childNodes[f]===a)break;else if(d.isChildOf(a,b.childNodes[f])===!0)return d.arrayMerge(c,d.getElementsBetween(b.childNodes[f],a));else c.push(b.childNodes[f]);return c}for(e=b.nextSibling;e;)if(d.isChildOf(a,e)===!0)return c=d.arrayMerge(c,d.getElementsBetween(e,a));else if(e===a)return c;else c.push(e),e=e.nextSibling;for(var e=d.getParents(b),f=d.getParents(a),
e=d.arrayDiff(e,f,!0),f=e.length,g=0;g<f-1;g++)c=d.arrayMerge(c,d.getSiblings(e[g],"next"));return c=d.arrayMerge(c,d.getElementsBetween(e[e.length-1],a))};d.getCommonAncestor=function(b,a){for(var c=b;c;){if(d.isChildOf(a,c)===!0)return c;c=c.parentNode}return null};d.getNextNode=function(b){if(b.nextSibling)return b.nextSibling;else if(b.parentNode)return d.getFirstChild(b.parentNode);return null};d.getPrevNode=function(b){if(b.previousSibling)return b.previousSibling;else if(b.parentNode)return d.getLastChild(b.parentNode);
return null};d.getFirstChild=function(b){return b.firstChild?b.firstChild.nodeType===d.ELEMENT_NODE?d.getFirstChild(b.firstChild):b.firstChild:b};d.getLastChild=function(b){return b.lastChild?b.lastChild.nodeType===d.ELEMENT_NODE?d.getLastChild(b.lastChild):b.lastChild:b};d.removeEmptyNodes=function(b,a){for(var c=jQuery(b).find(":empty"),e=c.length;e>0;)e--,d.isStubElement(c[e])===!1&&(!a||a.call(this,c[e])!==!1)&&d.remove(c[e])};d.create=function(b){return jQuery(b)[0]};d.find=function(b,a){return jQuery(b).find(a)};
d.children=function(b,a){return jQuery(b).children(a)};d.parent=function(b,a){return jQuery(b).parent(a)[0]};d.parents=function(b,a){return jQuery(b).parents(a)};d.is=function(b,a){return jQuery(b).is(a)};d.extend=function(b,a,c,e){return jQuery.extend.apply(this,arguments)};d.walk=function(b,a,c){b&&(c||(c=0),a.call(this,b,c)!==!1&&(b.childNodes&&b.childNodes.length>0?d.walk(b.firstChild,a,c+1):b.nextSibling?d.walk(b.nextSibling,a,c):b.parentNode&&b.parentNode.nextSibling&&d.walk(b.parentNode.nextSibling,
a,c-1)))};d.revWalk=function(b,a){b&&a.call(this,b)!==!1&&(b.childNodes&&b.childNodes.length>0?d.walk(b.lastChild,a):b.previousSibling?d.walk(b.previousSibling,a):b.parentNode&&b.parentNode.previousSibling&&d.walk(b.parentNode.previousSibling,a))};d.setStyle=function(b,a,c){b&&jQuery(b).css(a,c)};d.getStyle=function(b,a){return jQuery(b).css(a)};d.hasClass=function(b,a){return jQuery(b).hasClass(a)};d.addClass=function(b,a){jQuery(b).addClass(a)};d.removeClass=function(b,a){jQuery(b).removeClass(a)};
d.preventDefault=function(b){b.preventDefault();d.stopPropagation(b)};d.stopPropagation=function(b){b.stopPropagation()};d.noInclusionInherits=function(b,a){if(a instanceof String||typeof a==="string")a=window[a];if(b instanceof String||typeof b==="string")b=window[b];var c=function(){};if(d.isset(a)===!0)for(value in a.prototype)b.prototype[value]?c.prototype[value]=a.prototype[value]:b.prototype[value]=a.prototype[value];if(b.prototype)c.prototype.constructor=a,b.prototype["super"]=new c};d.each=
function(b,a){jQuery.each(b,function(b,e){a.call(this,b,e)})};d.foreach=function(b,a){if(b instanceof Array||b instanceof NodeList||typeof b.length!="undefined"&&typeof b.item!="undefined")for(var c=b.length,e=0;e<c;e++){var d=a.call(this,e,b[e]);if(d===!1)break}else for(c in b)if(b.hasOwnProperty(c)===!0&&(d=a.call(this,c),d===!1))break};d.isBlank=function(b){return!b||/^\s*$/.test(b)?!0:!1};d.isFn=function(b){return typeof b==="function"?!0:!1};d.isObj=function(b){return b!==null&&typeof b==="object"?
!0:!1};d.isset=function(b){return typeof b!=="undefined"&&b!==null?!0:!1};d.isArray=function(b){return jQuery.isArray(b)};d.isNumeric=function(b){return b.match(/^\d+$/)!==null?!0:!1};d.getUniqueId=function(){return((new Date).getTime()+""+Math.ceil(Math.random()*1E6)).substr(5,18).replace(/,/,"")};d.inArray=function(b,a){for(var c=a.length,e=0;e<c;e++)if(b===a[e])return!0;return!1};d.arrayDiff=function(b,a,c){for(var e=b.length,f=[],g=0;g<e;g++)d.inArray(b[g],a)===!1&&f.push(b[g]);if(c!==!0){e=a.length;
for(g=0;g<e;g++)d.inArray(a[g],b)===!1&&f.push(a[g])}return f};d.arrayMerge=function(b,a){for(var c=a.length,e=0;e<c;e++)b.push(a[e]);return b};d.stripTags=function(b,a){if(typeof a==="string"){var c=jQuery("<div>"+b+"</div>");c.find("*").not(a).remove();return c.html()}else{for(var e=RegExp(/<\/?(\w+)((\s+\w+(\s*=\s*(?:".*?"|'.*?'|[^'">\s]+))?)+\s*|\s*)\/?>/gim),f=b;(c=e.exec(b))!=null;)if(d.isset(a)===!1||d.inArray(c[1],a)!==!0)f=f.replace(c[0],"");return f}};d.browser=function(){var b={};b.version=
jQuery.browser.version;if(jQuery.browser.mozilla===!0)b.type="mozilla";else if(jQuery.browser.msie===!0)b.type="msie";else if(jQuery.browser.opera===!0)b.type="opera";else if(jQuery.browser.safari===!0)b.type="safari";return b};d.getBrowserType=function(){if(this._browserType===null){for(var b=["msie","firefox","chrome","safari"],a=b.length,c=0;c<a;c++)if(RegExp(b[c],"i").test(navigator.userAgent)===!0)return this._browserType=b[c];this._browserType="other"}return this._browserType};d.isBrowser=function(b){return d.browser().type===
b};d.getBlockParent=function(b,a){if(b)for(;b.parentNode;){b=b.parentNode;if(b===a)break;if(d.isBlockElement(b)===!0)return b}return null};d.onBlockBoundary=function(b,a,c){if(!b||!a)return!1;b=d.isChildOfTagName(b,c)||d.is(b,c)&&b||null;a=d.isChildOfTagName(a,c)||d.is(a,c)&&a||null;return b!==a};d.mergeContainers=function(b,a){if(!b||!a)return!1;if(b.nodeType===d.TEXT_NODE||d.isStubElement(b))a.appendChild(b);else if(b.nodeType===d.ELEMENT_NODE){for(;b.firstChild;)a.appendChild(b.firstChild);d.remove(b)}return!0};
d.mergeBlockWithSibling=function(b,a,c){var e=c?a.nextSibling:a.previousSibling;c?d.mergeContainers(e,a):d.mergeContainers(a,e);b.collapse(!0);return!0};d.date=function(b,a,c){if(a===null&&c&&(a=d.tsIso8601ToTimestamp(c),!a))return;for(var a=new Date(a),b=b.split(""),c=b.length,e="",f=0;f<c;f++){var g="",i=b[f];switch(i){case "D":case "l":g=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][a.getDay()];i==="D"&&(g=g.substring(0,3));break;case "F":case "m":g=a.getMonth()+1;g<
10&&(g="0"+g);break;case "M":months=["January","February","March","April","May","June","July","August","September","October","November","December"];g=months[a.getMonth()];i==="M"&&(g=g.substring(0,3));break;case "d":g=a.getDate();break;case "S":g=d.getOrdinalSuffix(a.getDate());break;case "Y":g=a.getFullYear();break;case "y":g=a.getFullYear();g=g.toString().substring(2);break;case "H":g=a.getHours();break;case "h":g=a.getHours();g===0?g=12:g>12&&(g-=12);break;case "i":g=d.addNumberPadding(a.getMinutes());
break;case "a":g="am";a.getHours()>=12&&(g="pm");break;default:g=i}e+=g}return e};d.getOrdinalSuffix=function(b){var a="",a=b%100;if(a>=4&&a<=20)a="th";else switch(b%10){case 1:a="st";break;case 2:a="nd";break;case 3:a="rd";break;default:a="th"}return a};d.addNumberPadding=function(b){b<10&&(b="0"+b);return b};d.tsIso8601ToTimestamp=function(b){if(b=b.match(RegExp(/(\d\d\d\d)(?:-?(\d\d)(?:-?(\d\d)(?:[T ](\d\d)(?::?(\d\d)(?::?(\d\d)(?:\.(\d+))?)?)?(?:Z|(?:([-+])(\d\d)(?::?(\d\d))?)?)?)?)?)?/))){var a=
new Date;a.setDate(b[3]);a.setFullYear(b[1]);a.setMonth(b[2]-1);a.setHours(b[4]);a.setMinutes(b[5]);a.setSeconds(b[6]);var c=b[9]*60;b[8]==="+"&&(c*=-1);c-=a.getTimezoneOffset();return a.getTime()+c*6E4}return null};this.dom=d}).call(this.ice);
(function(){var d;d=function(b,a,c){this.env=b;this.element=b.element;this.selection=this.env.selection;c||this.removeBookmarks(this.element);var b=a||this.selection.getRangeAt(0),a=b.cloneRange(),e=a.startContainer,d=a.startOffset;a.collapse(!1);c=this.env.document.createElement("span");c.style.display="none";ice.dom.setHtml(c,"&nbsp;");ice.dom.addClass(c,"iceBookmark iceBookmark_end");c.setAttribute("iceBookmark","end");a.insertNode(c);ice.dom.isChildOf(c,this.element)||this.element.appendChild(c);
a.setStart(e,d);a.collapse(!0);e=this.env.document.createElement("span");e.style.display="none";ice.dom.addClass(e,"iceBookmark iceBookmark_start");ice.dom.setHtml(e,"&nbsp;");e.setAttribute("iceBookmark","start");try{a.insertNode(e),e.previousSibling===c&&(a=e,e=c,c=a)}catch(g){ice.dom.insertBefore(c,e)}ice.dom.isChildOf(e,this.element)===!1&&(this.element.firstChild?ice.dom.insertBefore(this.element.firstChild,e):this.element.appendChild(e));c.previousSibling||(a=this.env.document.createTextNode(""),
ice.dom.insertBefore(c,a));e.nextSibling||(a=this.env.document.createTextNode(""),ice.dom.insertAfter(e,a));b.setStart(e.nextSibling,0);b.setEnd(c.previousSibling,c.previousSibling.length||0);this.start=e;this.end=c};d.prototype={selectBookmark:function(){var b=this.selection.getRangeAt(0),a=null,c=null,e=0,d=null;if(this.start.nextSibling===this.end||ice.dom.getElementsBetween(this.start,this.end).length===0)if(this.end.nextSibling)a=ice.dom.getFirstChild(this.end.nextSibling);else if(this.start.previousSibling){if(a=
ice.dom.getFirstChild(this.start.previousSibling),a.nodeType===ice.dom.TEXT_NODE)e=a.length}else this.end.parentNode.appendChild(this.env.document.createTextNode("")),a=ice.dom.getFirstChild(this.end.nextSibling);else this.start.nextSibling?a=ice.dom.getFirstChild(this.start.nextSibling):(this.start.previousSibling||(a=this.env.document.createTextNode(""),ice.dom.insertBefore(this.start,a)),a=ice.dom.getLastChild(this.start.previousSibling),e=a.length),this.end.previousSibling?c=ice.dom.getLastChild(this.end.previousSibling):
(c=ice.dom.getFirstChild(this.end.nextSibling),d=0);ice.dom.remove([this.start,this.end]);c===null?(b.setEnd(a,e),b.collapse(!1)):(b.setStart(a,e),d===null&&(d=c.length||0),b.setEnd(c,d));try{this.selection.addRange(b)}catch(g){}},getBookmark:function(b,a){return ice.dom.getClass("iceBookmark_"+a,b)[0]},removeBookmarks:function(b){ice.dom.remove(ice.dom.getClass("iceBookmark",b,"span"))}};this.Bookmark=d}).call(this.ice);
(function(){var d;d=function(b){this._selection=null;this.env=b;this._initializeRangeLibrary();this._selection=this.env.frame?rangy.getIframeSelection(this.env.frame):rangy.getSelection()};d.prototype={_getSelection:function(){this._selection?this._selection.refresh():this._selection=this.env.frame?rangy.getIframeSelection(this.env.frame):rangy.getSelection();return this._selection},createRange:function(){return rangy.createRange(this.env.document)},getRangeAt:function(b){this._selection.refresh();
try{return this._selection.getRangeAt(b)}catch(a){return this.createRange()}},addRange:function(b){this._selection||(this._selection=this._getSelection());this._selection.setSingleRange(b);this._selection.ranges=[b]},_initializeRangeLibrary:function(){var b=this;rangy.init();rangy.config.checkSelectionRanges=!1;rangy.rangePrototype.moveStart=function(a,b){if(b===0)throw Error("InvalidArgumentException: units cannot be 0");switch(a){case ice.dom.CHARACTER_UNIT:b>0?this.moveCharRight(!0,b):this.moveCharLeft(!0,
b)}};rangy.rangePrototype.moveEnd=function(a,b){if(b===0)throw Error("InvalidArgumentException: units cannot be 0");switch(a){case ice.dom.CHARACTER_UNIT:b>0?this.moveCharRight(!1,b):this.moveCharLeft(!1,b)}};rangy.rangePrototype.setRange=function(a,b,e){a?this.setStart(b,e):this.setEnd(b,e)};rangy.rangePrototype.moveCharLeft=function(a,b){var e,d;a?(e=this.startContainer,d=this.startOffset):(e=this.endContainer,d=this.endOffset);d+=b;if(d<0)for(;d<0;){var g=[];if(!this.getPreviousContainer(e,g)){if(b===
-1)return;d=0;break}e=this.getPreviousContainer(e,g);if(e.nodeType!==ice.dom.ELEMENT_NODE)d=e.data.length,d--}this.setRange(a,e,d)};rangy.rangePrototype.moveCharRight=function(a,b){var e,d;a?(e=this.startContainer,d=this.startOffset):(e=this.endContainer,d=this.endOffset);e.nodeType===ice.dom.ELEMENT_NODE?(e=e.childNodes[d],e.nodeType!==ice.dom.TEXT_NODE&&(e=this.getNextTextNode(e)),d=b):d+=b;var g=d-e.data.length;if(g>0){for(d=[];g>0;)if(e=this.getNextContainer(e,d),e.nodeType!==ice.dom.ELEMENT_NODE)if(e.data.length>=
g)break;else e.data.length>0&&(g-=e.data.length);d=g}this.setRange(a,e,d)};rangy.rangePrototype.getNextContainer=function(a,b){if(!a)return null;for(;a.nextSibling;)if(a=a.nextSibling,a.nodeType!==ice.dom.TEXT_NODE){var e=this.getFirstSelectableChild(a);if(e!==null)return e}else if(this.isSelectable(a)===!0)return a;for(;a&&!a.nextSibling;)a=a.parentNode;if(!a)return null;a=a.nextSibling;if(this.isSelectable(a)===!0)return a;else b&&ice.dom.isBlockElement(a)===!0&&b.push(a);e=this.getFirstSelectableChild(a);
return e!==null?e:this.getNextContainer(a,b)};rangy.rangePrototype.getPreviousContainer=function(a,b){if(!a)return null;for(;a.previousSibling;)if(a=a.previousSibling,a.nodeType!==ice.dom.TEXT_NODE)if(ice.dom.isStubElement(a)===!0)return a;else{var e=this.getLastSelectableChild(a);if(e!==null)return e}else if(this.isSelectable(a)===!0)return a;for(;a&&!a.previousSibling;)a=a.parentNode;if(!a)return null;a=a.previousSibling;if(this.isSelectable(a)===!0)return a;else b&&ice.dom.isBlockElement(a)===
!0&&b.push(a);e=this.getLastSelectableChild(a);return e!==null?e:this.getPreviousContainer(a,b)};rangy.rangePrototype.getStartOffset=function(a){if(a===!0)return this.startOffset;for(var a=0,b=this.startContainer,e=b.data.charCodeAt(0);e===10||e===32;)a++,e=b.data.charCodeAt(a);return this.startOffset-a};rangy.rangePrototype.getNextTextNode=function(a){if(a.nodeType===ice.dom.ELEMENT_NODE&&a.childNodes.length!==0)return this.getFirstSelectableChild(a);a=this.getNextContainer(a);return a.nodeType===
ice.dom.TEXT_NODE?a:this.getNextTextNode(a)};rangy.rangePrototype.getFirstSelectableChild=function(a){if(a)if(a.nodeType!==ice.dom.TEXT_NODE)for(a=a.firstChild;a;)if(this.isSelectable(a)===!0)return a;else if(a.firstChild){var b=this.getFirstSelectableChild(a);if(b!==null)return b;else a=a.nextSibling}else a=a.nextSibling;else return a;return null};rangy.rangePrototype.getLastSelectableChild=function(a){if(a)if(a.nodeType!==ice.dom.TEXT_NODE)for(a=a.lastChild;a;)if(this.isSelectable(a)===!0)return a;
else if(a.lastChild){var b=this.getLastSelectableChild(a);if(b!==null)return b;else a=a.previousSibling}else a=a.previousSibling;else return a;return null};rangy.rangePrototype.isSelectable=function(a){return a&&a.nodeType===ice.dom.TEXT_NODE&&a.data.length!==0?!0:!1};rangy.rangePrototype.getHTMLContents=function(a){a||(a=this.cloneContents());var c=b.env.document.createElement("div");c.appendChild(a.cloneNode(!0));return c.innerHTML};rangy.rangePrototype.getHTMLContentsObj=function(){return this.cloneContents()}}};
this.Selection=d}).call(this.ice);
(function(){var d=function(b){this._ice=b};d.prototype={start:function(){},clicked:function(){return!0},mouseDown:function(){return!0},keyDown:function(){return!0},keyPress:function(){return!0},selectionChanged:function(){},setEnabled:function(){},setDisabled:function(){},caretUpdated:function(){},nodeInserted:function(){},nodeCreated:function(){},caretPositioned:function(){},remove:function(){this._ice.removeKeyPressListener(this)},setSettings:function(){}};this.IcePlugin=d}).call(this.ice);
(function(){var d=function(b){this.plugins={};this.pluginConstructors={};this.keyPressListeners={};this.activePlugin=null;this.pluginSets={};this.activePluginSet=null;this._ice=b};d.prototype={getPluginNames:function(){var b=[],a;for(a in this.plugins)b.push(a);return b},addPluginObject:function(b,a){this.plugins[b]=a},addPlugin:function(b,a){if(typeof a!=="function")throw Error("IcePluginException: plugin must be a constructor function");ice.dom.isset(this.pluginConstructors[b])===!1&&(this.pluginConstructors[b]=
a)},loadPlugins:function(b,a){if(b.length===0)a.call(this);else{var c=b.shift();if(typeof c==="object")c=c.name;if(ice.dom.isset(ice._plugin[c])===!0)this.addPlugin(c,ice._plugin[c]),this.loadPlugins(b,a);else throw Error("plugin was not included in the page: "+c);}},_enableSet:function(b){this.activePluginSet=b;for(var a=this.pluginSets[b].length,c=0;c<a;c++){var e=this.pluginSets[b][c],d="",d=typeof e==="object"?e.name:e,g=this.pluginConstructors[d];g&&(g=new g(this._ice),this.plugins[d]=g,ice.dom.isset(e.settings)===
!0&&g.setSettings(e.settings),g.start())}},setActivePlugin:function(b){this.activePlugin=b},getActivePlugin:function(){return this.activePlugin},_getPluginName:function(b){b=b.toString();return b.substr(9,b.indexOf("(")-9)},removePlugin:function(b){this.plugins[b]&&this.plugins[b].remove()},getPlugin:function(b){return this.plugins[b]},usePlugins:function(b,a,c){var e=this;this.pluginSets[b]=ice.dom.isset(a)===!0?a:[];this.loadPlugins(this.pluginSets[b].concat([]),function(){e._enableSet(b);c&&c.call(this)})},
disablePlugin:function(b){this.plugins[b].disable()},isPluginElement:function(b){for(var a in this.plugins)if(this.plugins[a].isPluginElement&&this.plugins[a].isPluginElement(b)===!0)return!0;return!1},fireKeyPressed:function(b){if(this._fireKeyPressFns(b,"all_keys")===!1)return!1;var a=[];(b.ctrlKey===!0||b.metaKey===!0)&&a.push("ctrl");b.shiftKey===!0&&a.push("shift");b.altKey===!0&&a.push("alt");switch(b.keyCode){case 13:a.push("enter");break;case ice.dom.DOM_VK_LEFT:a.push("left");break;case ice.dom.DOM_VK_RIGHT:a.push("right");
break;case ice.dom.DOM_VK_UP:a.push("up");break;case ice.dom.DOM_VK_DOWN:a.push("down");break;case 9:a.push("tab");break;case ice.dom.DOM_VK_DELETE:a.push("delete");break;default:var c;if(b.keyCode)c=b.keyCode;else if(b.which)c=b.which;c&&a.push(String.fromCharCode(c).toLowerCase())}a=a.sort().join("+");return this._fireKeyPressFns(b,a)},_fireKeyPressFns:function(b,a){if(this.keyPressListeners[a])for(var c=this.keyPressListeners[a].length,e=0;e<c;e++){var d=this.keyPressListeners[a][e],g=d.fn,i=d.plugin,
d=d.data;if(g)if(ice.dom.isFn(g)===!0){if(g.call(i,b,d)===!0)return ice.dom.preventDefault(b),!1}else if(i[g]&&i[g].call(i,b,d)===!0)return ice.dom.preventDefault(b),!1}return!0},fireSelectionChanged:function(b){for(var a in this.plugins)this.plugins[a].selectionChanged(b)},fireNodeInserted:function(b,a){for(var c in this.plugins)if(this.plugins[c].nodeInserted(b,a)===!1)return!1},fireNodeCreated:function(b,a){for(var c in this.plugins)if(this.plugins[c].nodeCreated(b,a)===!1)return!1},fireCaretPositioned:function(){for(var b in this.plugins)this.plugins[b].caretPositioned()},
fireClicked:function(b){var a=!0,c;for(c in this.plugins)this.plugins[c].clicked(b)===!1&&(a=!1);return a},fireMouseDown:function(b){var a=!0,c;for(c in this.plugins)this.plugins[c].mouseDown(b)===!1&&(a=!1);return a},fireKeyDown:function(b){var a=!0,c;for(c in this.plugins)this.plugins[c].keyDown(b)===!1&&(a=!1);return a},fireKeyPress:function(b){var a=!0,c;for(c in this.plugins)this.plugins[c].keyPress(b)===!1&&(a=!1);return a},fireEnabled:function(b){for(var a in this.plugins)this.plugins[a].setEnabled(b)},
fireDisabled:function(b){for(var a in this.plugins)this.plugins[a].setDisabled(b)},fireCaretUpdated:function(){for(var b in this.plugins)this.plugins[b].caretUpdated&&this.plugins[b].caretUpdated()}};this._plugin={};this.IcePluginManager=d}).call(this.ice);
(function(){var d;d=function(b){this._ice=b};d.prototype={nodeCreated:function(b,a){b.setAttribute("title",(a.action||"Modified")+" by "+b.getAttribute(this._ice.userNameAttribute)+" - "+ice.dom.date("m/d/Y h:ia",parseInt(b.getAttribute(this._ice.timeAttribute))))}};ice.dom.noInclusionInherits(d,ice.IcePlugin);this._plugin.IceAddTitlePlugin=d}).call(this.ice);
(function(){var d;d=function(b){this._ice=b;this._tmpNode=null;this._tmpNodeTagName="icepaste";var a=this;this.pasteType="formattedClean";this.preserve="p";this.beforePasteClean=function(a){return a};this.afterPasteClean=function(a){return a};b.element.oncopy=function(){return a.handleCopy.apply(a)};b.element.oncut=function(){return a.handleCut.apply(a)};b.element.onpaste=function(){return a.handlePaste.apply(a)}};d.prototype={setSettings:function(b){b=b||{};ice.dom.extend(this,b);this.preserve+=
","+this._tmpNodeTagName;this.setupPreserved()},handleCut:function(){if(this._ice.isTracking){var b=this._ice.getCurrentRange();if(!b.collapsed){var a=b.cloneContents(),c=this;setTimeout(function(){c.doCut(a)},1);return!0}}},doCut:function(b){var a=this._ice.getCurrentRange(),c,e;this._tmpNode=this._ice.env.document.createElement("span");a.insertNode(this._tmpNode);a.setStartAfter(this._tmpNode);for(a.collapse(!0);c=b.firstChild;)a.insertNode(c),a.setStartAfter(c),a.collapse(!0),e=c;a.setStartBefore(this._tmpNode);
a.collapse(!0);a.setEndAfter(e);this._ice.env.selection.addRange(a);this._ice.deleteContents(null,null,"cutType");ice.dom.remove(this._tmpNode)},handleCopy:function(){},handlePaste:function(){var b=this._ice.getCurrentRange();b.collapsed||(this._ice.isTracking?(this._ice.deleteContents(),b=b.cloneRange()):(b.deleteContents(),b.collapse(!0)));this._ice.isTracking&&this._ice._moveRangeToValidTrackingPos(b);if(b.startContainer==this._ice.element){var a=ice.dom.find(this._ice.element,this._ice.blockEl)[0];
a||(a=ice.dom.create("<"+this._ice.blockEl+" ><br/></"+this._ice.blockEl+">"),this._ice.element.appendChild(a));b.setStart(a,0);b.collapse(!0);this._ice.env.selection.addRange(b)}this._tmpNode=this._ice.env.document.createElement(this._tmpNodeTagName);b.insertNode(this._tmpNode);b=ice.dom.extractContent(this._ice.element);a=this._ice.env.selection.createRange();a.selectNodeContents(this._ice.element);this._ice.env.selection.addRange(a);switch(this.pasteType){case "formatted":this.handleFormattedPaste(b);
break;case "formattedClean":this.handleFormattedPaste(b,!0)}return!0},handleFormattedPaste:function(b,a){var c=this;window.setTimeout(function(){c.handleFormattedPasteValue(b,a)},1);return!0},handleFormattedPasteValue:function(b,a){var c=this.beforePasteClean(this._ice.element.innerHTML),e=ice.dom.children("<div>"+c+"</div>",this._ice.blockEl);e.length===1&&ice.dom.getNodeTextContent("<div>"+c+"</div>")===ice.dom.getNodeTextContent(e)&&(c=ice.dom.getHtml(c));a&&(c=this._ice.getCleanContent(c),c=this.stripPaste(c));
c=this.afterPasteClean.call(this,c);c=ice.dom.trim(c);this._ice.element.innerHTML="";this._ice.element.appendChild(b);var d=this._ice.getCurrentRange();d.setStartAfter(this._tmpNode);d.collapse(!0);var g=null,c=d.createContextualFragment(c),e=this._ice.startBatchChange();if(ice.dom.hasBlockChildren(c)){var i=ice.dom.isChildOfTagName(this._tmpNode,this._ice.blockEl);d.setEndAfter(i.lastChild);this._ice.selection.addRange(d);var g=d.extractContents(),k=this._ice.env.document.createElement(this._ice.blockEl);
k.appendChild(g);ice.dom.insertAfter(i,k);d.setStart(k,0);d.collapse(!0);this._ice.selection.addRange(d);for(var d=d.startContainer,n=null,i=null;c.firstChild;)if(c.firstChild.nodeType===3&&!jQuery.trim(c.firstChild.nodeValue))c.removeChild(c.firstChild);else if(ice.dom.isBlockElement(c.firstChild)){if(c.firstChild.textContent!=="")i=n=null,this._ice.isTracking?(i=this._ice.createIceNode("insertType"),this._ice.addChange("insertType",[i]),g=document.createElement(c.firstChild.tagName),i.innerHTML=
c.firstChild.innerHTML,g.appendChild(i)):(i=g=document.createElement(c.firstChild.tagName),g.innerHTML=c.firstChild.innerHTML),ice.dom.insertBefore(d,g);c.removeChild(c.firstChild)}else n||(g=document.createElement(this._ice.blockEl),ice.dom.insertBefore(d,g),this._ice.isTracking?(n=this._ice.createIceNode("insertType"),this._ice.addChange("insertType",[n]),g.appendChild(n)):n=g),i=n,n.appendChild(c.removeChild(c.firstChild));k.textContent||k.parentNode.removeChild(k)}else if(this._ice.isTracking)g=
this._ice.createIceNode("insertType",c),this._ice.addChange("insertType",[g]),d.insertNode(g),i=g;else for(;k=c.firstChild;)d.insertNode(k),d.setStartAfter(k),d.collapse(!0),i=k;this._ice.endBatchChange(e);this._cleanup(i)},createDiv:function(b){var a=ice.dom.getId(b);if(a)return ice.dom.empty(a),a;a=this._ice.env.document.createElement("div");a.id=b;a.setAttribute("contentEditable",!0);ice.dom.setStyle(a,"width","0px");ice.dom.setStyle(a,"height","0px");ice.dom.setStyle(a,"overflow","hidden");ice.dom.setStyle(a,
"position","fixed");ice.dom.setStyle(a,"top","10px");ice.dom.setStyle(a,"left","10px");document.body.appendChild(a);return a},handleCut:function(){this.cutElementId="icecut";this.cutElement=this.createDiv(this.cutElementId);var b=this._ice.getCurrentRange();if(!b.collapsed){var a=b.getHTMLContents();this._ice.isTracking?this._ice.deleteContents():b.deleteContents();var c=b.cloneRange();c.collapse(!0);this.cutElement.innerHTML=a;b.setStart(this.cutElement.firstChild,0);b.setEndAfter(this.cutElement.lastChild,
this.cutElement.lastChild.length);var e=this;setTimeout(function(){b.setStart(c.startContainer,c.startOffset);b.collapse(!0);e._ice.env.selection.addRange(b);ice.dom.remove(this.cutElement)},10)}},stripPaste:function(b){b=this._cleanWordPaste(b);return b=this.cleanPreserved(b)},setupPreserved:function(){var b=this;this._tags="";this._attributesMap=[];ice.dom.each(this.preserve.split(","),function(a,c){c.match(/(\w+)(\[(.+)\])?/);var e=RegExp.$1,d=RegExp.$3;b._tags&&(b._tags+=",");b._tags+=e.toLowerCase();
b._attributesMap[e]=d.split("|")})},cleanPreserved:function(b){var a=this,c=this._ice.env.document.createElement("div");c.innerHTML=b;c=ice.dom.stripEnclosingTags(c,this._tags);ice.dom.each(ice.dom.find(c,this._tags),function(b,c){var d=c.tagName.toLowerCase(),d=a._attributesMap[d];if(d[0]&&d[0]==="*")return!0;if(c.hasAttributes())for(var i=c.attributes,b=i.length-1;b>=0;b--)ice.dom.inArray(i[b].name,d)||c.removeAttribute(i[b].name)});return c.innerHTML},_cleanWordPaste:function(b){b=b.replace(/<(meta|link)[^>]+>/g,
"");b=b.replace(/<\!--(.|\s)*?--\>/g,"");b=b.replace(/<style>[\s\S]*?<\/style>/g,"");b=b.replace(/<\/?\w+:[^>]*>/gi,"");b=b.replace(/<\\?\?xml[^>]*>/gi,"");b=this._cleanPaste(b);b=this._convertWordPasteList(b);b=b.replace(/<(\w[^>]*) (lang)=([^ |>]*)([^>]*)/gi,"<$1$4");return b=b.replace(RegExp('<(\\w[^>]*) style="([^"]*)"([^>]*)',"gi"),"<$1$3")},_getListType:function(b,a){var c=ice.dom.getHtml(b),e=null;ice.dom.foreach(a,function(b){ice.dom.foreach(a[b],function(d){ice.dom.foreach(a[b][d],function(i){if(RegExp(a[b][d][i]).test(c)===
!0)return e={html:c.replace(RegExp(a[b][d][i]),""),listType:b,listStyle:d},!1});if(e!==null)return!1});if(e!==null)return!1});return e},_convertWordPasteList:function(b){var a=document.createElement("div"),c=null,d=null,f={},g=null,i=!0,k={ul:{circle:["^o(s|&nbsp;)+"],disc:["^"+String.fromCharCode(183)+"(\\s|&nbsp;)+"],square:["^"+String.fromCharCode(167)+"(\\s|&nbsp;)+"],auto:["^"+String.fromCharCode(8226)+"(\\s|&nbsp;)+"]},ol:{decimal:["^\\d+\\.(s|&nbsp;)+"],"lower-roman":["^[ivxlcdm]+\\.(\\s|&nbsp;)+"],
"upper-roman":["^[IVXLCDM]+\\.(\\s|&nbsp;)+"],"lower-alpha":["^[a-z]+\\.(\\s|&nbsp;)+"],"upper-alpha":["^[A-Z]+\\.(\\s|&nbsp;)+"]}};ice.dom.setHtml(a,b);for(var b=ice.dom.getTag("p",a),n=b.length,m=0;m<n;m++){var s=b[m],o=this._getListType(s,k);if(o!==null){var h=parseInt(ice.dom.getStyle(s,"margin-left")),r=o.listType,j=o.listStyle;ice.dom.setHtml(s,o.html);r||(r="ol");i?(c=document.createElement(r),f={},ice.dom.attr(c,"_icelistst","list-style-type:"+j),f[h]=c,ice.dom.insertBefore(s,c)):h!==d&&(ice.dom.isset(f[h])===
!0?c=f[h]:h>d&&(c=document.createElement(r),ice.dom.attr(c,"_icelistst","list-style-type:"+j),g.appendChild(c),f[h]=c));g=this._createListItemFromElement(s);c.appendChild(g);d=h;ice.dom.remove(s);i=!1}else i=!0}return b=ice.dom.getHtml(a)},_createListItemFromElement:function(b){for(var a=document.createElement("li");b.firstChild;)a.appendChild(b.firstChild);return a},_cleanPaste:function(b){b=b.replace(/<b(\s+|>)/g,"<strong$1");b=b.replace(/<\/b(\s+|>)/g,"</strong$1");b=b.replace(/<i(\s+|>)/g,"<em$1");
return b=b.replace(/<\/i(\s+|>)/g,"</em$1")},_cleanup:function(b){try{var b=b&&b.lastChild||b||this._tmpNode,a=this._ice.getCurrentRange();a.setStart(b,b.length);a.collapse(!0);this._ice.selection.addRange(a);this._ice.env.frame?this._ice.env.frame.contentWindow.focus():this._ice.element.focus();this._tmpNode.parentNode.removeChild(this._tmpNode);this._tmpNode=null;for(var c=this._ice.env.document.getElementsByClassName(this._ice.changeTypes.insertType.alias),b=0;b<c.length;b++)c[b].textContent||
c[b].parentNode&&c[b].parentNode.removeChild(c[b])}catch(d){window.console&&console.error(d)}}};ice.dom.noInclusionInherits(d,ice.IcePlugin);this._plugin.IceCopyPastePlugin=d}).call(this.ice);
(function(){var d=this.ice,b=function(a){this._ice=a};b.prototype={convert:function(a){var b=this;d.dom.each(a.getElementsByTagName(this.ice.blockEl),function(a,d){try{b.ice.placeholdDeletes(),b._convertBlock(d)}catch(g){console.error(g)}finally{b.ice.revertDeletePlaceholders()}})},_convertBlock:function(a){if(!(a.textContent.length<2)){var b=String.fromCharCode(8216),d=String.fromCharCode(8217),f=String.fromCharCode(8220),g=String.fromCharCode(8221),i=function(a){return a===String.fromCharCode(160)||
a===String.fromCharCode(32)},k=this.ice.selection.createRange(),n=a.cloneNode(!0);k.setStart(n,0);k.collapse(!0);for(var n=[],m=null,s=null,o=null,h=0;;)try{k.moveEnd("character",1),n.push(k.cloneContents().textContent.charAt(h++))}catch(r){break}for(h=0;h<=n.length;h++)switch(m=s,s=o,o=n.length===h?null:n[h],s){case b:case d:this.replaceCharAtPosition("'",h,a);case "'":(m===null||i(m))&&/\d/.test(o)&&/\d/.test(n[h+1])&&i(n[h+2])?this.replaceCharAtPosition(d,h,a):m===null||i(m)&&!i(o)?this.replaceCharAtPosition(b,
h,a):o===null||!i(m)&&i(o)?this.replaceCharAtPosition(d,h,a):/\w/.test(m)&&/\w/.test(o)&&this.replaceCharAtPosition(d,h,a);break;case f:case g:this.replaceCharAtPosition('"',h,a);case '"':m===null||i(m)&&!i(o)?this.replaceCharAtPosition(f,h,a):o===null||!i(m)&&i(o)?this.replaceCharAtPosition(g,h,a):(m===null||i(m))&&i(o)&&(n[h+1]==="'"||n[h+1]===b||n[h+1]===d)?this.replaceCharAtPosition(f,h,a):(o===null||i(o))&&i(m)&&(n[h-3]==="'"||n[h-3]===b||n[h-3]===d)&&this.replaceCharAtPosition(g,h,a)}}},replaceCharAtPosition:function(a,
b,d){var f=this.ice.selection.createRange();for(f.setStart(d,0);b-- >1;)f.moveStart("character",1);try{f.moveStart("character",1),f.moveStart("character",-1)}catch(g){}f.collapse(!0);f.moveEnd("character",1);f.extractContents();this.ice.insert(a,f)}};d.dom.noInclusionInherits(b,d.IcePlugin);this.ice._plugin.IceSmartQuotesPlugin=b}).call(this);
(function(){var d=function(b){this._ice=b};d.prototype={keyDown:function(b){if(ice.dom.isBrowser("mozilla")){if(b.keyCode===109)return this.convertEmdash(b)}else if(b.keyCode===189)return this.convertEmdash(b);return!0},convertEmdash:function(){var b=this._ice.getCurrentRange();if(b.collapsed){try{b.moveStart(ice.dom.CHARACTER_UNIT,-1);var a=ice.dom.getParents(b.startContainer,this._ice.blockEl)[0],c=ice.dom.getParents(b.endContainer,this._ice.blockEl)[0];if(a===c&&!this._ice.getIceNode(b.startContainer,
"deleteType")){var d=b.cloneContents();if(ice.dom.getNodeTextContent(d)==="-")return b.extractContents(),b.collapse(),this._ice.insert(this._ice.env.document.createTextNode("\u2014"),b),b=this._ice.getCurrentRange(),b.moveStart(ice.dom.CHARACTER_UNIT,1),b.collapse(!0),this._ice.env.selection.addRange(b),!1}}catch(f){}b.collapse()}return!0}};ice.dom.noInclusionInherits(d,ice.IcePlugin);this._plugin.IceEmdashPlugin=d}).call(this.ice);
